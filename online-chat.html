<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>20‰∏≠Â≠¶Âú®Á∫øËÅäÂ§©ÂÆ§</title>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <style>
        /* Âü∫Á°ÄÊ†∑Âºè‰ºòÂåñÔºåÊèêÂçá‰∏ªÈ¢òÂàáÊç¢ÊÄßËÉΩ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #e8f0fe;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', system-ui, sans-serif;
            padding: 12px;
            margin: 0;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        body.dark-mode {
            background: #1a2a36;
        }
        body.dark-mode .chat-container {
            background: rgba(25, 38, 48, 0.95);
            border-color: #2e5068;
        }
        body.dark-mode .header h1 {
            color: #e2efff;
        }
        body.dark-mode .header h1 span {
            background: #254b62;
            color: #cbe6fe;
            border-color: #3d6e8f;
        }
        body.dark-mode .peer-count,
        body.dark-mode .anon-checkbox,
        body.dark-mode .file-upload-label,
        body.dark-mode .theme-toggle,
        body.dark-mode .current-time {
            background: #243b4a;
            border-color: #3f6079;
            color: #e2f0ff;
        }
        
        body.dark-mode .nickname-group,
        body.dark-mode .avatar-group,
        body.dark-mode .gender-group {
            background: #243b4a;
            border-color: #3f6079;
        }
        
        body.dark-mode .nickname-edit-btn {
            background: #2d4457;
            border-color: #3f6079;
            color: #e2f0ff;
        }
        
        body.dark-mode .avatar-selector {
            background: transparent;
            color: #e2f0ff;
        }
        
        body.dark-mode .reset-avatar-btn {
            background: #2d4457;
            color: #e2f0ff;
        }

        body.dark-mode .gender-option {
            background: #2d4457;
            color: #e2f0ff;
            border-color: #3f6079;
        }
        body.dark-mode .gender-option.active {
            background: #3a7bb0;
            border-color: #7ab0d5;
        }
        
        body.dark-mode .name-input {
            background: transparent;
            color: #e2f0ff;
        }
        body.dark-mode .name-input::placeholder {
            color: #9bb7d0;
        }
        
        body.dark-mode .peer-count::before {
            color: #6ae2a0;
        }
        body.dark-mode .messages-area {
            background: rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .message-bubble {
            background: #263f50;
            border-color: #386480;
            color: #eaf3fc;
        }
        body.dark-mode .message-self .message-bubble {
            background: #1e577a;
            border-color: #4790c0;
            color: #ffffff;
        }
        body.dark-mode .message-header .sender-name {
            color: #bddbff;
        }
        body.dark-mode .timestamp {
            color: #9ab9d6;
        }
        body.dark-mode .file-link,
        body.dark-mode .image-preview,
        body.dark-mode .audio-link {
            background: #1c4057;
            border-color: #3674a0;
            color: #ddf0ff;
        }
        body.dark-mode .system-message {
            background: #1e4057;
            color: #cbe5ff;
            border-color: #3a74a0;
        }
        body.dark-mode .input-area {
            background: rgba(10, 30, 40, 0.7);
        }
        body.dark-mode .message-input {
            background: #1d3a4b;
            border-color: #36698b;
            color: #f0f8ff;
        }
        body.dark-mode .message-input::placeholder {
            color: #9abfda;
        }
        body.dark-mode .send-button {
            background: #2f73a0;
            box-shadow: 0 4px 12px #0f2e40;
            border-color: #7ab0d5;
        }
        body.dark-mode .file-tag {
            background: #254a5e;
            border-color: #3b78a0;
            color: #e2f0ff;
        }
        body.dark-mode .info-tip,
        body.dark-mode .current-time {
            color: #9fc9ec;
        }
        body.dark-mode .modal-content {
            background: #263f54;
            border-color: #3f79a0;
        }
        body.dark-mode .modal-title {
            color: #e2f0ff;
        }
        body.dark-mode .crop-btn {
            background: #2f6290;
            color: white;
            border-color: #4790c0;
        }
        body.dark-mode .crop-btn.primary {
            background: #3a7bb0;
            color: white;
        }
        body.dark-mode .audio-player-modal {
            background: #1d3a4b;
            border-color: #3674a0;
        }
        body.dark-mode .audio-player-modal select,
        body.dark-mode .audio-player-modal .download-link {
            background: #2d4457;
            color: #e2f0ff;
            border-color: #3f6079;
        }

        /* ÊÄßÂà´È¢úËâ≤ */
        .gender-male { color: #2196F3; }
        .gender-female { color: #E91E63; }
        .gender-unknown { color: #000000; }
        body.dark-mode .gender-unknown { color: #cccccc; }

        .chat-container {
            max-width: 1200px;
            width: 100%;
            height: 90vh;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 38px;
            box-shadow: 0 20px 40px rgba(0, 40, 60, 0.2), 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.7);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: border-color 0.2s, background 0.2s;
        }

        .header {
            padding: 16px 24px 8px 24px;
            border-bottom: 1px solid rgba(150, 180, 200, 0.2);
            flex-shrink: 0;
        }

        .logo-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .logo {
            width: 42px;
            height: 42px;
            background-color: #C46220;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(196, 98, 32, 0.3);
            flex-shrink: 0;
        }

        .logo-cross {
            width: 24px;
            height: 24px;
            position: relative;
        }

        .logo-cross::before,
        .logo-cross::after {
            content: '';
            position: absolute;
            background-color: #FFFFFF;
            border-radius: 8px;
        }

        .logo-cross::before {
            width: 24px;
            height: 4px;
            top: 10px;
            left: 0;
        }

        .logo-cross::after {
            width: 4px;
            height: 24px;
            left: 10px;
            top: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 400;
            color: #1a3d4c;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header h1 span {
            background: #d7ecff;
            font-size: 0.85rem;
            padding: 4px 14px;
            border-radius: 30px;
            color: #1f5775;
            font-weight: 300;
            border: 1px solid #aaccf0;
            white-space: nowrap;
        }

        .sub-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 6px;
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .peer-count {
            background: white;
            padding: 5px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            color: #1a4b64;
            border: 1px solid #bee0fa;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            cursor: pointer;
            transition: background 0.1s;
        }
        .peer-count:hover {
            background: #e7f2fc;
        }

        .peer-count::before {
            content: "‚óè";
            color: #2ea86b;
            font-size: 1.2rem;
        }

        .theme-toggle {
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 40px;
            padding: 5px 14px;
            font-size: 0.9rem;
            color: #1f5a7a;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .name-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .anon-checkbox {
            display: flex;
            align-items: center;
            background: white;
            padding: 5px 14px 5px 10px;
            border-radius: 30px;
            border: 1px solid #c7ddef;
            gap: 6px;
            font-size: 0.9rem;
            color: #1a4356;
            cursor: pointer;
            white-space: nowrap;
        }

        .anon-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: #3f9ed6;
            margin: 0;
        }

        .nickname-group {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            padding: 3px 3px 3px 16px;
            transition: background 0.2s, border-color 0.2s;
        }

        .name-input {
            background: transparent;
            border: none;
            padding: 6px 0;
            font-size: 0.95rem;
            color: #0f3448;
            outline: none;
            width: 110px;
            transition: color 0.2s;
        }

        .name-input:focus {
            outline: none;
        }

        .nickname-edit-btn {
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 30px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #1f5a7a;
            transition: 0.1s;
            flex-shrink: 0;
        }

        .nickname-edit-btn:hover {
            background: #e7f2fc;
        }

        .avatar-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            padding: 3px 3px 3px 6px;
            transition: background 0.2s, border-color 0.2s;
        }
        
        .avatar-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #1f5770;
            position: relative;
            white-space: nowrap;
            transition: color 0.2s;
        }
        
        .avatar-selector input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }
        
        .avatar-preview {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #d4e6f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border: 1px solid white;
            background-size: cover;
            background-position: center;
            z-index: 1;
            pointer-events: none;
            flex-shrink: 0;
        }
        
        .avatar-selector span {
            pointer-events: none;
            z-index: 1;
        }
        
        .reset-avatar-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #1f5a7a;
            flex-shrink: 0;
            transition: background 0.2s, color 0.2s;
        }

        /* ÊÄßÂà´ÈÄâÊã©ÁªÑ */
        .gender-group {
            display: flex;
            align-items: center;
            gap: 4px;
            background: white;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            padding: 3px 4px;
            transition: background 0.2s, border-color 0.2s;
        }
        .gender-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            background: transparent;
            border: 1px solid transparent;
            transition: 0.1s;
        }
        .gender-option[data-gender="male"] { color: #2196F3; }
        .gender-option[data-gender="female"] { color: #E91E63; }
        .gender-option[data-gender="unknown"] { color: #000000; }
        body.dark-mode .gender-option[data-gender="unknown"] { color: #cccccc; }
        .gender-option.active {
            background: #d7ecff;
            border-color: #aaccf0;
        }
        body.dark-mode .gender-option.active {
            background: #3a7bb0;
            border-color: #7ab0d5;
        }

        .messages-area {
            flex: 1 1 auto;
            padding: 16px 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 14px;
            background: rgba(255,255,255,0.25);
            min-height: 0;
        }

        .message {
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.2s ease;
            position: relative;
        }

        .message-self {
            align-self: flex-end;
        }

        .message-other {
            align-self: flex-start;
        }

        .message-bubble {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px 24px 24px 8px;
            padding: 10px 16px;
            color: #174257;
            line-height: 1.4;
            font-size: 0.95rem;
        }

        .message-self .message-bubble {
            background: #d1ecfe;
            border: 1px solid #b7defa;
            border-radius: 24px 24px 8px 24px;
            color: #05455c;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .msg-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #cee5f5;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: #2d5775;
            font-size: 0.85rem;
            border: 1px solid white;
        }

        .message-self .message-header {
            flex-direction: row-reverse;
        }

        .sender-name {
            font-weight: 600;
            color: #0f4a67;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .gender-symbol {
            font-size: 0.9rem;
        }

        .timestamp {
            opacity: 0.6;
            font-size: 0.65rem;
            margin-left: 4px;
        }

        .message-body {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .quote-block {
            background: rgba(0,0,0,0.05);
            border-left: 3px solid #2d7fc1;
            padding: 6px 10px;
            margin-top: 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #1f5a7a;
        }
        .quote-sender {
            font-weight: 600;
            margin-bottom: 2px;
        }
        body.dark-mode .quote-block {
            background: rgba(255,255,255,0.1);
            color: #bddbff;
        }

        .file-attachment {
            margin-top: 6px;
            border-top: 1px dashed #aac8e0;
            padding-top: 6px;
        }

        .file-link, .image-preview, .audio-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.02);
            border-radius: 20px;
            padding: 5px 12px;
            text-decoration: none;
            color: #1d6185;
            border: 1px solid #cae0f0;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .audio-link {
            background: #f0f7ff;
        }

        .image-preview img {
            max-width: 160px;
            max-height: 160px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid white;
        }

        .recall-btn {
            background: transparent;
            border: none;
            color: #8ba0b5;
            font-size: 0.65rem;
            margin-left: 6px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 30px;
            opacity: 0.5;
        }

        .system-message {
            text-align: center;
            font-size: 0.75rem;
            color: #477e9e;
            background: rgba(215, 235, 250, 0.6);
            padding: 5px 16px;
            border-radius: 40px;
            align-self: center;
            border: 1px solid #c0dbf2;
            max-width: 90%;
        }

        .input-area {
            padding: 12px 24px 12px 24px;
            background: rgba(255,255,255,0.5);
            border-top: 1px solid rgba(150,180,200,0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .selected-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 36px;
            padding: 0 4px;
        }

        .quote-preview {
            background: rgba(0,0,0,0.03);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.85rem;
            color: #1f5a7a;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #cae0f0;
        }
        .quote-preview .remove-quote {
            background: none;
            border: none;
            color: #7a9cba;
            font-size: 1.1rem;
            cursor: pointer;
            margin-left: auto;
        }
        
        .file-tag {
            background: rgba(255,255,255,0.8);
            border-radius: 30px;
            padding: 4px 12px 4px 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #bedaf7;
            color: #05455c;
        }
        
        .file-tag .remove-file {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: #7a9cba;
            cursor: pointer;
            padding: 0 2px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .message-input {
            flex: 1 1 200px;
            min-width: 160px;
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 0.95rem;
            color: #0c3e55;
            outline: none;
        }
        
        .file-upload-label {
            background: white;
            border-radius: 40px;
            padding: 9px 18px;
            border: 1px solid #c7ddef;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #1f5a7a;
            font-size: 0.9rem;
            position: relative;
            white-space: nowrap;
        }
        
        .file-upload-label input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .send-button {
            background: #2d7fc1;
            border: none;
            border-radius: 60px;
            padding: 12px 28px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            border: 1px solid white;
            white-space: nowrap;
            transition: background 0.1s;
        }
        .send-button:hover {
            background: #1a6bb0;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px 12px 24px;
            flex-shrink: 0;
        }
        .info-tip {
            color: #588cad;
            font-size: 0.75rem;
        }
        .current-time {
            color: #588cad;
            font-size: 0.75rem;
            background: white;
            padding: 5px 16px;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
        }

        /* Ëá™ÂÆö‰πâ‰∏ä‰∏ãÊñáËèúÂçï */
        .context-menu {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid #c7ddef;
            z-index: 2000;
            overflow: hidden;
            min-width: 120px;
        }
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #1f5a7a;
            transition: 0.1s;
        }
        .context-menu-item:hover {
            background: #e7f2fc;
        }
        body.dark-mode .context-menu {
            background: #243b4a;
            border-color: #3f6079;
        }
        body.dark-mode .context-menu-item {
            color: #e2f0ff;
        }
        body.dark-mode .context-menu-item:hover {
            background: #2d4457;
        }

        /* Ê®°ÊÄÅÊ°ÜÈÄöÁî® */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.5);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 14px;
            color: #174257;
        }
        .crop-container {
            max-height: 280px;
            margin-bottom: 18px;
        }
        #cropImage {
            max-width: 100%;
            max-height: 260px;
        }
        .crop-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        .crop-btn {
            padding: 8px 22px;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            background: white;
            color: #1f5a7a;
            cursor: pointer;
            font-weight: 500;
            transition: 0.1s;
        }
        .crop-btn.primary {
            background: #2d7fc1;
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(45, 127, 193, 0.3);
        }
        .crop-btn.primary:hover {
            background: #1a6bb0;
        }

        /* È¢ÑËßàÊ®°ÊÄÅÊ°ÜÔºàÂõæÁâá/Èü≥È¢ëÔºâ */
        #previewModal .modal-content {
            max-width: 800px;
            text-align: center;
        }
        .preview-container {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            background: #000;
            border-radius: 12px;
        }
        #previewImage {
            max-width: none;
            transition: transform 0.1s;
            transform-origin: center center;
            cursor: grab;
            user-select: none;
            width: 100%;
            height: auto;
            max-height: 60vh;
            object-fit: contain;
        }
        #previewImage:active {
            cursor: grabbing;
        }
        .audio-player-modal {
            background: #f0f7ff;
            border-radius: 24px;
            padding: 20px;
            width: 100%;
            border: 1px solid #cae0f0;
        }
        .audio-controls-modal {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .audio-controls-modal select {
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 30px;
            padding: 8px 15px;
            font-size: 0.9rem;
            color: #1f5a7a;
            outline: none;
        }
        .download-link-modal {
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 30px;
            padding: 8px 20px;
            text-decoration: none;
            color: #1f5a7a;
            font-size: 0.9rem;
        }

        /* Âú®Á∫øÂàóË°® */
        .user-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e0ecf9;
        }
        .user-list-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #d4e6f5;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            color: #1f5a7a;
            flex-shrink: 0;
        }
        .user-list-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .user-list-name {
            font-weight: 600;
            color: #174257;
        }
        .user-list-gender {
            font-size: 1.1rem;
        }
        .user-list-duration {
            font-size: 0.8rem;
            color: #588cad;
            margin-left: auto;
            white-space: nowrap;
        }
        .user-list-self {
            color: #2d7fc1;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 700px) {
            body { padding: 8px; }
            .chat-container { height: 95vh; border-radius: 28px; }
            .header { padding: 12px 18px 6px 18px; }
            .logo-row { gap: 8px; }
            .logo { width: 36px; height: 36px; }
            .logo-cross { width: 20px; height: 20px; }
            .logo-cross::before { width: 20px; height: 3px; top: 8.5px; }
            .logo-cross::after { width: 3px; height: 20px; left: 8.5px; }
            .header h1 { font-size: 1.4rem; }
            .header h1 span { font-size: 0.75rem; padding: 3px 10px; }
            
            .sub-bar { flex-direction: column; align-items: stretch; }
            .left-controls { justify-content: space-between; }
            .name-section { justify-content: flex-start; }
            
            .nickname-group { padding-left: 12px; }
            .name-input { width: 90px; }
            
            .messages-area { padding: 12px 16px; }
            .message { max-width: 90%; }
            
            .input-area { padding: 10px 16px 10px 16px; }
            .input-row { gap: 8px; }
            .message-input { padding: 10px 16px; font-size: 0.9rem; }
            .file-upload-label { padding: 7px 14px; font-size: 0.85rem; }
            .send-button { padding: 10px 20px; font-size: 0.9rem; }
            .file-tag { font-size: 0.75rem; padding: 3px 10px; }
            
            .footer { flex-direction: column; gap: 5px; align-items: flex-start; }
            .current-time { align-self: flex-end; }
        }

        @media (max-width: 480px) {
            .name-section { gap: 8px; }
            .anon-checkbox { width: 100%; margin-bottom: 2px; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <div class="logo-row">
                <div class="logo">
                    <div class="logo-cross"></div>
                </div>
                <h1>
                    20‰∏≠Â≠¶Âú®Á∫øËÅäÂ§©ÂÆ§
                    <span>P2P Ê∏ÖÊñ∞Áâà</span>
                </h1>
            </div>
            <div class="sub-bar">
                <div class="left-controls">
                    <div class="peer-count" id="peerCountDisplay">0 ‰∫∫Âú®Á∫ø</div>
                    <div class="theme-toggle" id="themeToggleBtn">üåì Êó•Â§ú</div>
                </div>
                <div class="name-section">
                    <label class="anon-checkbox">
                        <input type="checkbox" id="anonCheckbox"> ÂåøÂêç
                    </label>
                    
                    <div class="nickname-group">
                        <input type="text" id="nicknameInput" class="name-input" placeholder="ÊòµÁß∞" maxlength="20" value="ÂêåÂ≠¶">
                        <div class="nickname-edit-btn" id="renameButton" title="Á°ÆËÆ§‰øÆÊîπÊòµÁß∞">‚úèÔ∏è</div>
                    </div>
                    
                    <div class="avatar-group">
                        <div class="avatar-selector" id="avatarSelector">
                            <div class="avatar-preview" id="avatarPreview">üì∑</div>
                            <span>Â§¥ÂÉè</span>
                            <input type="file" id="avatarUpload" accept="image/*">
                        </div>
                        <div class="reset-avatar-btn" id="resetAvatarBtn" title="ÊÅ¢Â§çÈªòËÆ§Â§¥ÂÉè">‚Ü∫</div>
                    </div>

                    <!-- ÊÄßÂà´ÈÄâÊã© -->
                    <div class="gender-group" id="genderGroup">
                        <div class="gender-option" data-gender="male" title="Áî∑">‚ôÇ</div>
                        <div class="gender-option" data-gender="female" title="Â•≥">‚ôÄ</div>
                        <div class="gender-option active" data-gender="unknown" title="‰∏çÊÑøÈÄèÈú≤">‚ö≤</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="messages-area" id="messageContainer">
            <div class="system-message" id="welcomeMessage">üëã Ê¨¢ËøéÊù•Âà∞20‰∏≠Â≠¶Âú®Á∫øËÅäÂ§©ÂÆ§</div>
        </div>

        <div class="input-area">
            <div class="selected-files" id="selectedFilesPreview"></div>
            <div class="quote-preview" id="quotePreview" style="display: none;">
                <span id="quoteText"></span>
                <button class="remove-quote" id="removeQuoteBtn">‚úï</button>
            </div>
            <div class="input-row">
                <input type="text" id="messageInput" class="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                <label class="file-upload-label">
                    üìé Êñá‰ª∂
                    <input type="file" id="fileInput" multiple>
                </label>
                <button class="send-button" id="sendButton">ÂèëÈÄÅ</button>
            </div>
        </div>
        <div class="footer">
            <div class="info-tip" id="infoTip">‚ú® v1.0 ¬∑ ‰∏çÂÆöÊúüÊõ¥Êñ∞ ¬∑ Êï¨ËØ∑ÊúüÂæÖ</div>
            <div class="current-time" id="currentTime">‚è±Ô∏è Âä†ËΩΩ‰∏≠...</div>
        </div>
    </div>

    <!-- Ë£ÅÂâ™Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="cropModal">
        <div class="modal-content">
            <div class="modal-title">‚úÇÔ∏è Ë£ÅÂâ™Â§¥ÂÉè</div>
            <div class="crop-container">
                <img id="cropImage" src="" alt="Ë£ÅÂâ™È¢ÑËßà">
            </div>
            <div class="crop-actions">
                <button class="crop-btn" id="cancelCrop">ÂèñÊ∂à</button>
                <button class="crop-btn primary" id="applyCrop">Â∫îÁî®</button>
            </div>
        </div>
    </div>

    <!-- ÈÄöÁî®È¢ÑËßàÊ®°ÊÄÅÊ°ÜÔºàÂõæÁâá/Èü≥È¢ëÔºâ -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-title" id="previewModalTitle">üñºÔ∏è È¢ÑËßà</div>
            <div class="preview-container" id="previewContainer"></div>
            <div class="crop-actions" style="margin-top: 15px;">
                <button class="crop-btn" id="closePreview">ÂÖ≥Èó≠</button>
                <button class="crop-btn primary" id="saveMedia">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- Âú®Á∫øÁî®Êà∑ÂàóË°®Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="userListModal">
        <div class="modal-content">
            <div class="modal-title">üë• Âú®Á∫øÊàêÂëò</div>
            <div id="userListContainer" style="max-height: 50vh; overflow-y: auto;"></div>
            <div class="crop-actions" style="margin-top: 15px;">
                <button class="crop-btn primary" id="closeUserList">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- Ëá™ÂÆö‰πâ‰∏ä‰∏ãÊñáËèúÂçï -->
    <div id="contextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item" id="contextQuote">üí¨ ÂºïÁî®</div>
    </div>

    <script type="module">
        // ---------- 20‰∏≠Â≠¶P2PËÅäÂ§©ÂÆ§ ¬∑ ‰∏≠Â§ÆÂçèË∞ÉËäÇÁÇπÊñπÊ°à + ÊÄßÂà´È¢úËâ≤ + Èü≥È¢ëÈ¢ÑËßà + ÂõæÁâáÁº©ÊîæÊãñÊãΩ + ÂºïÁî® + Âú®Á∫øÊó∂Èïø + Âåó‰∫¨Êó∂Èó¥ ----------
        import Peer from 'https://esm.sh/peerjs@1.5.4?bundle-deps';
        import Cropper from 'https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/+esm';

        const PEER_OPTIONS = {
            config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] }
        };
        const FIXED_HUB_ID = '20zhongxue-p2p-hub-2026';
        const MAX_HISTORY = 200;

        let peer = null;
        let myId = null;
        let myName = 'ÂêåÂ≠¶' + Math.floor(Math.random() * 1000); // ËåÉÂõ¥0~999
        let isAnonymous = false;
        let myAvatarData = null;
        let myGender = 'unknown';
        const connections = new Map();
        const mySentMessages = new Map();

        const onlineUsers = new Map(); // key: originId, value: { name, avatar, anon, gender, joinTime }
        let messageHistory = [];
        let historyLoaded = false;
        let pendingMessages = [];
        let pendingFiles = [];

        // ÂºïÁî®Áõ∏ÂÖ≥
        let quoteMessage = null; // { msgId, sender, text, files? }

        // DOM ÂÖÉÁ¥†
        const messageContainer = document.getElementById('messageContainer');
        const peerCountDisplay = document.getElementById('peerCountDisplay');
        const nicknameInput = document.getElementById('nicknameInput');
        const renameButton = document.getElementById('renameButton');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const anonCheckbox = document.getElementById('anonCheckbox');
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarPreview = document.getElementById('avatarPreview');
        const fileInput = document.getElementById('fileInput');
        const selectedFilesPreview = document.getElementById('selectedFilesPreview');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const resetAvatarBtn = document.getElementById('resetAvatarBtn');
        const genderOptions = document.querySelectorAll('.gender-option');
        const quotePreview = document.getElementById('quotePreview');
        const quoteText = document.getElementById('quoteText');
        const removeQuoteBtn = document.getElementById('removeQuoteBtn');
        const currentTimeEl = document.getElementById('currentTime');

        const cropModal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');
        const cancelCrop = document.getElementById('cancelCrop');
        const applyCrop = document.getElementById('applyCrop');
        let cropper = null;

        const previewModal = document.getElementById('previewModal');
        const previewModalTitle = document.getElementById('previewModalTitle');
        const previewContainer = document.getElementById('previewContainer');
        const closePreview = document.getElementById('closePreview');
        const saveMedia = document.getElementById('saveMedia');

        const userListModal = document.getElementById('userListModal');
        const userListContainer = document.getElementById('userListContainer');
        const closeUserList = document.getElementById('closeUserList');

        const contextMenu = document.getElementById('contextMenu');
        const contextQuote = document.getElementById('contextQuote');

        let currentPreviewType = null; // 'image', 'audio'
        let currentMediaSrc = null;
        let currentMediaFile = null; // Áî®‰∫é‰∏ãËΩΩ
        let mediaScale = 1;
        let mediaTranslateX = 0, mediaTranslateY = 0;
        let isDragging = false;
        let dragStartX, dragStartY;
        let lastTouchDistance = null;
        let pinchCenter = null;
        let containerRect = null;
        let mediaRect = null;

        nicknameInput.value = myName;

        // Âåó‰∫¨Êó∂Èó¥ÂÆûÊó∂Êõ¥Êñ∞
        function updateBeijingTime() {
            const now = new Date();
            // ËΩ¨Êç¢‰∏∫Âåó‰∫¨Êó∂Èó¥ (UTC+8)
            const beijingTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (8 * 3600000));
            const year = beijingTime.getFullYear();
            const month = String(beijingTime.getMonth() + 1).padStart(2, '0');
            const day = String(beijingTime.getDate()).padStart(2, '0');
            const hours = String(beijingTime.getHours()).padStart(2, '0');
            const minutes = String(beijingTime.getMinutes()).padStart(2, '0');
            const seconds = String(beijingTime.getSeconds()).padStart(2, '0');
            currentTimeEl.textContent = `üá®üá≥ ${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        updateBeijingTime();
        setInterval(updateBeijingTime, 1000);

        // ÊÄßÂà´ÈÄâÊã©
        genderOptions.forEach(opt => {
            opt.addEventListener('click', () => {
                genderOptions.forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                const newGender = opt.dataset.gender;
                if (newGender !== myGender) {
                    myGender = newGender;
                    // ÂπøÊí≠‰∏™‰∫∫‰ø°ÊÅØÊõ¥Êñ∞
                    broadcastProfileUpdate();
                }
            });
        });

        // ÂπøÊí≠‰∏™‰∫∫‰ø°ÊÅØÊõ¥Êñ∞ÔºàÊòµÁß∞„ÄÅÂ§¥ÂÉè„ÄÅÂåøÂêç„ÄÅÊÄßÂà´Ôºâ
        function broadcastProfileUpdate() {
            const updatePayload = {
                type: 'profileUpdate',
                originId: myId,
                name: myName,
                avatar: myAvatarData,
                anon: isAnonymous,
                gender: myGender,
                joinTime: window.selfJoinTime
            };
            for (let conn of connections.values()) {
                if (conn.open) conn.send(updatePayload);
            }
            // Êõ¥Êñ∞Ëá™Â∑±ÁöÑÂú®Á∫øÂàóË°®ÊòæÁ§∫ÔºàÂú®‰∏ãÊ¨°ÊâìÂºÄÂàóË°®Êó∂Ôºâ
        }

        // ÁõëÂê¨ÊòµÁß∞‰øÆÊîπ„ÄÅÂ§¥ÂÉè‰øÆÊîπ„ÄÅÂåøÂêç‰øÆÊîπÔºåË∞ÉÁî®broadcastProfileUpdate
        renameButton.addEventListener('click', () => {
            const newName = nicknameInput.value.trim();
            if (newName && newName !== myName) {
                myName = newName;
                addSystemMessage(`‚ú® ÊòµÁß∞Â∑≤‰øÆÊîπ‰∏∫ "${myName}"`);
                broadcastProfileUpdate();
            } else {
                nicknameInput.value = myName;
            }
        });

        anonCheckbox.addEventListener('change', (e) => {
            isAnonymous = e.target.checked;
            broadcastProfileUpdate();
        });

        // Â§¥ÂÉè‰øÆÊîπÂêé‰πüË¶ÅÂπøÊí≠
        function afterAvatarChange() {
            broadcastProfileUpdate();
        }

        // È¢ÑËßàÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
        function closePreviewModal() {
            // ÊöÇÂÅúÈü≥È¢ë
            const audio = previewContainer.querySelector('audio');
            if (audio) audio.pause();
            previewModal.style.display = 'none';
            resetMediaTransform();
        }

        closePreview.addEventListener('click', closePreviewModal);
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) {
                closePreviewModal();
            }
        });
        saveMedia.addEventListener('click', () => {
            if (currentMediaSrc && currentMediaFile) {
                const link = document.createElement('a');
                link.href = currentMediaSrc;
                link.download = currentMediaFile.name || 'media';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else if (currentMediaSrc && currentPreviewType === 'image') {
                const link = document.createElement('a');
                link.href = currentMediaSrc;
                link.download = 'image_' + Date.now() + '.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // ÈáçÁΩÆÂèòÊç¢
        function resetMediaTransform() {
            mediaScale = 1;
            mediaTranslateX = 0;
            mediaTranslateY = 0;
            isDragging = false;
            lastTouchDistance = null;
            const mediaEl = document.getElementById('previewImage');
            if (mediaEl) {
                mediaEl.style.transform = `scale(${mediaScale}) translate(${mediaTranslateX}px, ${mediaTranslateY}px)`;
            }
        }

        // Ëé∑ÂèñÂÆπÂô®ÂíåÂ™í‰ΩìÂ∞∫ÂØ∏‰ª•ËÆ°ÁÆóËæπÁïå
        function getMediaBoundaries() {
            const mediaEl = document.getElementById('previewImage');
            if (!mediaEl || !previewContainer) return { minX: -Infinity, maxX: Infinity, minY: -Infinity, maxY: Infinity };
            const container = previewContainer;
            const containerRect = container.getBoundingClientRect();
            const mediaRect = mediaEl.getBoundingClientRect();
            // ËÆ°ÁÆóÂú®scaleÂêéÁöÑÂÆûÈôÖÂ∞∫ÂØ∏
            const scaledWidth = mediaRect.width / mediaScale; // ÂéüÂßãÂÆΩÂ∫¶
            const scaledHeight = mediaRect.height / mediaScale;
            const effectiveWidth = scaledWidth * mediaScale;
            const effectiveHeight = scaledHeight * mediaScale;

            // ÂèØÁßªÂä®ËåÉÂõ¥Ôºö‰øùËØÅÂõæÁâáËá≥Â∞ëÂ°´Êª°ÂÆπÂô®Ôºå‰∏çËÉΩÁßªÂá∫ËæπÁïåÂØºËá¥Á©∫ÁôΩ
            const maxX = Math.max(0, (effectiveWidth - containerRect.width) / 2);
            const minX = -maxX;
            const maxY = Math.max(0, (effectiveHeight - containerRect.height) / 2);
            const minY = -maxY;
            return { minX, maxX, minY, maxY };
        }

        // ÂõæÁâáÁº©ÊîæÊãñÊãΩÈÄªËæë
        function handleMediaWheel(e) {
            if (currentPreviewType !== 'image') return;
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            mediaScale = Math.min(3, Math.max(0.5, mediaScale + delta));
            applyMediaTransformWithBoundary();
        }

        function handleMediaMouseDown(e) {
            if (currentPreviewType !== 'image') return;
            e.preventDefault();
            isDragging = true;
            dragStartX = e.clientX - mediaTranslateX;
            dragStartY = e.clientY - mediaTranslateY;
            const mediaEl = document.getElementById('previewImage');
            if (mediaEl) mediaEl.style.cursor = 'grabbing';
        }

        function handleMediaMouseMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            mediaTranslateX = e.clientX - dragStartX;
            mediaTranslateY = e.clientY - dragStartY;
            applyMediaTransformWithBoundary();
        }

        function handleMediaMouseUp(e) {
            if (isDragging) {
                isDragging = false;
                const mediaEl = document.getElementById('previewImage');
                if (mediaEl) mediaEl.style.cursor = 'grab';
            }
        }

        function handleMediaTouchStart(e) {
            if (currentPreviewType !== 'image') return;
            if (e.touches.length === 1) {
                e.preventDefault();
                isDragging = true;
                dragStartX = e.touches[0].clientX - mediaTranslateX;
                dragStartY = e.touches[0].clientY - mediaTranslateY;
            } else if (e.touches.length === 2) {
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lastTouchDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
                pinchCenter = {
                    x: (touch1.clientX + touch2.clientX) / 2,
                    y: (touch1.clientY + touch2.clientY) / 2
                };
            }
        }

        function handleMediaTouchMove(e) {
            if (currentPreviewType !== 'image') return;
            if (e.touches.length === 1 && isDragging) {
                e.preventDefault();
                mediaTranslateX = e.touches[0].clientX - dragStartX;
                mediaTranslateY = e.touches[0].clientY - dragStartY;
                applyMediaTransformWithBoundary();
            } else if (e.touches.length === 2 && lastTouchDistance !== null) {
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const newDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
                const scaleChange = newDistance / lastTouchDistance;
                mediaScale = Math.min(3, Math.max(0.5, mediaScale * scaleChange));
                lastTouchDistance = newDistance;
                applyMediaTransformWithBoundary();
            }
        }

        function handleMediaTouchEnd(e) {
            if (currentPreviewType !== 'image') return;
            if (e.touches.length === 0) {
                isDragging = false;
                lastTouchDistance = null;
            } else if (e.touches.length === 1) {
                lastTouchDistance = null;
            }
        }

        function applyMediaTransformWithBoundary() {
            const mediaEl = document.getElementById('previewImage');
            if (!mediaEl) return;

            const boundaries = getMediaBoundaries();
            mediaTranslateX = Math.min(boundaries.maxX, Math.max(boundaries.minX, mediaTranslateX));
            mediaTranslateY = Math.min(boundaries.maxY, Math.max(boundaries.minY, mediaTranslateY));

            mediaEl.style.transform = `scale(${mediaScale}) translate(${mediaTranslateX}px, ${mediaTranslateY}px)`;
        }

        // Âú®Á∫øÂàóË°®Ê®°ÊÄÅÊ°Ü
        closeUserList.addEventListener('click', () => {
            userListModal.style.display = 'none';
        });
        peerCountDisplay.addEventListener('click', () => {
            updateUserListModal();
            userListModal.style.display = 'flex';
            // ÂêØÂä®ÂÆûÊó∂Êõ¥Êñ∞
            if (window.durationInterval) clearInterval(window.durationInterval);
            window.durationInterval = setInterval(() => {
                if (userListModal.style.display === 'flex') {
                    updateUserListModal();
                } else {
                    clearInterval(window.durationInterval);
                }
            }, 1000);
        });

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateUserListModal() {
            const now = Date.now();
            let html = '';
            // Ëá™Â∑±
            const selfGenderClass = myGender === 'male' ? 'gender-male' : (myGender === 'female' ? 'gender-female' : 'gender-unknown');
            const selfGenderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '‚ö≤' }[myGender] || '';
            const selfJoinTime = window.selfJoinTime || now;
            if (!window.selfJoinTime) window.selfJoinTime = now;
            const selfDuration = formatDuration((now - selfJoinTime) / 1000);
            html += `<div class="user-list-item">
                <div class="user-list-avatar" style="background-image: ${myAvatarData ? `url('${myAvatarData}')` : 'none'}">${!myAvatarData ? (myName.charAt(0).toUpperCase()) : ''}</div>
                <div class="user-list-info">
                    <span class="user-list-name">${isAnonymous ? 'ÂåøÂêç' : myName}</span>
                    <span class="user-list-gender ${selfGenderClass}">${!isAnonymous ? selfGenderSymbol : ''}</span>
                    <span class="user-list-self">(‰Ω†)</span>
                    <span class="user-list-duration">${selfDuration}</span>
                </div>
            </div>`;
            // ÂÖ∂‰ªñÁî®Êà∑
            for (let [id, info] of onlineUsers) {
                const genderClass = info.gender === 'male' ? 'gender-male' : (info.gender === 'female' ? 'gender-female' : 'gender-unknown');
                const genderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '‚ö≤' }[info.gender] || '';
                const duration = info.joinTime ? formatDuration((now - info.joinTime) / 1000) : '00:00:00';
                html += `<div class="user-list-item">
                    <div class="user-list-avatar" style="background-image: ${info.avatar ? `url('${info.avatar}')` : 'none'}">${!info.avatar ? (info.name ? info.name.charAt(0).toUpperCase() : '?') : ''}</div>
                    <div class="user-list-info">
                        <span class="user-list-name">${info.anon ? 'ÂåøÂêç' : info.name}</span>
                        <span class="user-list-gender ${genderClass}">${!info.anon ? genderSymbol : ''}</span>
                        <span class="user-list-duration">${duration}</span>
                    </div>
                </div>`;
            }
            userListContainer.innerHTML = html || '<div style="text-align:center;padding:20px;">ÊöÇÊó†ÂÖ∂‰ªñÁî®Êà∑</div>';
        }

        // ÂºïÁî®ÂäüËÉΩÔºöÂè≥ÈîÆ/ÈïøÊåâËèúÂçï
        messageContainer.addEventListener('contextmenu', (e) => {
            const messageEl = e.target.closest('.message');
            if (!messageEl) return;
            e.preventDefault();
            const msgId = messageEl.dataset.msgid;
            if (!msgId) return;
            // ‰ªéDOM‰∏≠Ëé∑ÂèñÂèëÈÄÅËÄÖÂíåÊñáÊú¨
            const senderNameEl = messageEl.querySelector('.sender-name');
            const sender = senderNameEl ? senderNameEl.childNodes[0].nodeValue.trim() : 'Êú™Áü•';
            const bodyEl = messageEl.querySelector('.message-body');
            const text = bodyEl ? bodyEl.textContent : '';
            // ÂºπÂá∫ËèúÂçï
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            // Â≠òÂÇ®Ë¢´ÂºïÁî®Ê∂àÊÅØ‰ø°ÊÅØ
            contextMenu.dataset.msgId = msgId;
            contextMenu.dataset.sender = sender;
            contextMenu.dataset.text = text;
        });

        // ÊâãÊú∫ÈïøÊåâ
        let longPressTimer;
        messageContainer.addEventListener('touchstart', (e) => {
            const messageEl = e.target.closest('.message');
            if (!messageEl) return;
            longPressTimer = setTimeout(() => {
                const msgId = messageEl.dataset.msgid;
                if (!msgId) return;
                const senderNameEl = messageEl.querySelector('.sender-name');
                const sender = senderNameEl ? senderNameEl.childNodes[0].nodeValue.trim() : 'Êú™Áü•';
                const bodyEl = messageEl.querySelector('.message-body');
                const text = bodyEl ? bodyEl.textContent : '';
                const touch = e.touches[0];
                contextMenu.style.display = 'block';
                contextMenu.style.left = touch.pageX + 'px';
                contextMenu.style.top = touch.pageY + 'px';
                contextMenu.dataset.msgId = msgId;
                contextMenu.dataset.sender = sender;
                contextMenu.dataset.text = text;
            }, 500);
        });
        messageContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
        messageContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));

        // ÈöêËóèËèúÂçï
        document.addEventListener('click', () => {
            contextMenu.style.display = 'none';
        });
        document.addEventListener('touchstart', (e) => {
            if (!e.target.closest('.context-menu')) contextMenu.style.display = 'none';
        });

        // ÂºïÁî®ËèúÂçïÈ°πÁÇπÂáª
        contextQuote.addEventListener('click', () => {
            const msgId = contextMenu.dataset.msgId;
            const sender = contextMenu.dataset.sender;
            const text = contextMenu.dataset.text;
            if (msgId && sender) {
                quoteMessage = { msgId, sender, text };
                quoteText.textContent = `ÂºïÁî® ${sender}Ôºö${text.substring(0, 50)}${text.length > 50 ? '...' : ''}`;
                quotePreview.style.display = 'flex';
            }
            contextMenu.style.display = 'none';
        });

        removeQuoteBtn.addEventListener('click', () => {
            quoteMessage = null;
            quotePreview.style.display = 'none';
        });

        // Êñá‰ª∂/Â™í‰ΩìÁÇπÂáªÂßîÊâò
        messageContainer.addEventListener('click', (e) => {
            const target = e.target;
            // ÂõæÁâáÈ¢ÑËßà
            if (target.tagName === 'IMG' && target.closest('.image-preview')) {
                e.preventDefault();
                openImagePreview(target.src);
            }
            // Èü≥È¢ëÈ¢ÑËßà
            if (target.classList.contains('audio-link') || target.closest('.audio-link')) {
                e.preventDefault();
                const link = target.classList.contains('audio-link') ? target : target.closest('.audio-link');
                const src = link.dataset.src;
                const filename = link.dataset.filename || 'audio.mp3';
                openAudioPreview(src, filename);
            }
            // ËßÜÈ¢ëÊñá‰ª∂Áé∞Âú®Áõ¥Êé•‰∏ãËΩΩÔºàÊó†ÈúÄÂ§ÑÁêÜÔºåÂõ†‰∏∫ÂÆÉÊòØÊôÆÈÄöÈìæÊé•Ôºâ
        });

        function openImagePreview(src) {
            currentPreviewType = 'image';
            currentMediaSrc = src;
            currentMediaFile = null;
            previewModalTitle.innerHTML = 'üñºÔ∏è ÂõæÁâáÈ¢ÑËßà';
            previewContainer.innerHTML = `<img id="previewImage" src="${src}" alt="È¢ÑËßà" style="cursor: grab; max-width: 100%; max-height: 60vh;">`;
            const img = document.getElementById('previewImage');
            resetMediaTransform();

            img.onload = () => {
                applyMediaTransformWithBoundary();
            };

            img.addEventListener('wheel', handleMediaWheel, { passive: false });
            img.addEventListener('mousedown', handleMediaMouseDown);
            img.addEventListener('mousemove', handleMediaMouseMove);
            img.addEventListener('mouseup', handleMediaMouseUp);
            img.addEventListener('mouseleave', handleMediaMouseUp);
            img.addEventListener('touchstart', handleMediaTouchStart);
            img.addEventListener('touchmove', handleMediaTouchMove, { passive: false });
            img.addEventListener('touchend', handleMediaTouchEnd);
            img.addEventListener('touchcancel', handleMediaTouchEnd);

            previewModal.style.display = 'flex';
        }

        function openAudioPreview(src, filename) {
            currentPreviewType = 'audio';
            currentMediaSrc = src;
            currentMediaFile = { name: filename };
            previewModalTitle.innerHTML = 'üéµ Èü≥È¢ëÈ¢ÑËßà';
            previewContainer.innerHTML = `
                <div class="audio-player-modal">
                    <audio id="previewAudio" controls src="${src}"></audio>
                    <div class="audio-controls-modal">
                        <select id="playbackRateSelect">
                            <option value="0.5">0.5x</option>
                            <option value="0.8">0.8x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.2">1.2x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                        <a href="${src}" download="${filename}" class="download-link-modal">‰∏ãËΩΩ</a>
                    </div>
                </div>
            `;
            const audio = document.getElementById('previewAudio');
            const rateSelect = document.getElementById('playbackRateSelect');
            rateSelect.addEventListener('change', () => {
                audio.playbackRate = parseFloat(rateSelect.value);
            });
            previewModal.style.display = 'flex';
        }

        function generateMsgId() { return Date.now() + '-' + Math.random().toString(36).substring(2,10); }

        function updateFilePreview() {
            if (!pendingFiles.length) { selectedFilesPreview.innerHTML = ''; return; }
            let html = '';
            pendingFiles.forEach((file, index) => {
                const name = file.name.length > 20 ? file.name.slice(0,17)+'...' : file.name;
                html += `<div class="file-tag">üìé ${escapeHTML(name)} (${(file.size/1024).toFixed(1)}KB)
                    <button class="remove-file" data-index="${index}">‚úï</button>
                </div>`;
            });
            selectedFilesPreview.innerHTML = html;
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.index);
                    pendingFiles.splice(idx, 1);
                    updateFilePreview();
                });
            });
        }
        function escapeHTML(str) { return String(str).replace(/[&<>"]/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

        fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);
            pendingFiles = [...pendingFiles, ...newFiles];
            updateFilePreview();
            fileInput.value = '';
        });

        // ‰∏ªÈ¢òÂàáÊç¢‰ºòÂåñÔºö‰ΩøÁî®requestAnimationFrameÈÅøÂÖçÂç°È°ø
        themeToggleBtn.addEventListener('click', () => {
            requestAnimationFrame(() => {
                document.body.classList.toggle('dark-mode');
            });
        });

        avatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                cropImage.src = ev.target.result;
                cropModal.style.display = 'flex';
                if (cropper) cropper.destroy();
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    cropBoxResizable: true,
                    background: false,
                });
            };
            reader.readAsDataURL(file);
            avatarUpload.value = '';
        });

        cancelCrop.addEventListener('click', () => {
            cropModal.style.display = 'none';
            if (cropper) { cropper.destroy(); cropper = null; }
        });

        applyCrop.addEventListener('click', () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 200, height: 200 });
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    myAvatarData = e.target.result;
                    avatarPreview.style.backgroundImage = `url('${myAvatarData}')`;
                    avatarPreview.textContent = '';
                    cropModal.style.display = 'none';
                    if (cropper) { cropper.destroy(); cropper = null; }
                    afterAvatarChange();
                };
                reader.readAsDataURL(blob);
            }, 'image/png');
        });

        resetAvatarBtn.addEventListener('click', () => {
            myAvatarData = null;
            avatarPreview.style.backgroundImage = '';
            avatarPreview.textContent = 'üì∑';
            afterAvatarChange();
        });

        function addMessageToUI(msgData, isSelf = false) {
            const { msgId, text, sender, time, files, recalled, senderAvatar, senderAnon, senderGender, quote } = msgData;
            if (recalled) return;

            const wrapper = document.createElement('div');
            wrapper.classList.add('message');
            if (msgId) wrapper.setAttribute('data-msgid', msgId);
            if (isSelf) wrapper.classList.add('message-self');
            else wrapper.classList.add('message-other');

            const headerDiv = document.createElement('div');
            headerDiv.classList.add('message-header');

            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('msg-avatar');

            let displayName = sender;
            if (senderAnon === true) {
                displayName = 'ÂåøÂêç';
                avatarDiv.style.backgroundImage = '';
                avatarDiv.textContent = '?';
            } else {
                if (senderAvatar) {
                    avatarDiv.style.backgroundImage = `url('${senderAvatar}')`;
                    avatarDiv.textContent = '';
                } else {
                    avatarDiv.textContent = displayName.charAt(0).toUpperCase();
                }
            }

            const nameSpan = document.createElement('span');
            nameSpan.classList.add('sender-name');
            nameSpan.textContent = displayName;

            // ÊÄßÂà´Á¨¶Âè∑ÔºàÈùûÂåøÂêçÔºâ
            if (!senderAnon && senderGender && senderGender !== 'unknown') {
                const genderSpan = document.createElement('span');
                genderSpan.classList.add('gender-symbol');
                const genderClass = senderGender === 'male' ? 'gender-male' : (senderGender === 'female' ? 'gender-female' : 'gender-unknown');
                genderSpan.classList.add(genderClass);
                genderSpan.textContent = senderGender === 'male' ? '‚ôÇ' : (senderGender === 'female' ? '‚ôÄ' : '‚ö≤');
                nameSpan.appendChild(genderSpan);
            }

            const timeSpan = document.createElement('span');
            timeSpan.classList.add('timestamp');
            timeSpan.textContent = time ? new Date(time).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : '';

            headerDiv.appendChild(avatarDiv);
            headerDiv.appendChild(nameSpan);
            headerDiv.appendChild(timeSpan);

            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('message-bubble');

            // Ê≠£Êñá
            const bodyDiv = document.createElement('div');
            bodyDiv.classList.add('message-body');
            bodyDiv.textContent = text || '';
            bubbleDiv.appendChild(bodyDiv);

            // ÂºïÁî®ÂùóÔºàÊîæÂú®Ê≠£Êñá‰∏ãÊñπÔºâ
            if (quote) {
                const quoteDiv = document.createElement('div');
                quoteDiv.classList.add('quote-block');
                quoteDiv.innerHTML = `<div class="quote-sender">${escapeHTML(quote.sender)}:</div><div>${escapeHTML(quote.text)}</div>`;
                bubbleDiv.appendChild(quoteDiv);
            }

            if (files && files.length > 0) {
                const attachDiv = document.createElement('div');
                attachDiv.classList.add('file-attachment');
                files.forEach(f => {
                    if (f.type.startsWith('image/')) {
                        const imgWrap = document.createElement('a');
                        imgWrap.href = f.data;
                        imgWrap.target = '_blank';
                        imgWrap.classList.add('image-preview');
                        const img = document.createElement('img');
                        img.src = f.data;
                        img.alt = f.name;
                        imgWrap.appendChild(img);
                        attachDiv.appendChild(imgWrap);
                    } else if (f.type.startsWith('audio/')) {
                        // Èü≥È¢ëÊñá‰ª∂ÔºöÊòæÁ§∫ÂèØÈ¢ÑËßàÈìæÊé•
                        const link = document.createElement('a');
                        link.href = '#';
                        link.classList.add('audio-link', 'file-link');
                        link.dataset.src = f.data;
                        link.dataset.filename = f.name;
                        link.textContent = `üéµ ${f.name}`;
                        attachDiv.appendChild(link);
                    } else {
                        // ËßÜÈ¢ëÂíåÂÖ∂‰ªñÊñá‰ª∂ÔºöÁõ¥Êé•‰∏ãËΩΩÈìæÊé•
                        const link = document.createElement('a');
                        link.href = f.data;
                        link.download = f.name;
                        link.classList.add('file-link');
                        link.textContent = `üìé ${f.name}`;
                        attachDiv.appendChild(link);
                    }
                });
                bubbleDiv.appendChild(attachDiv);
            }

            if (isSelf && msgId) {
                const recallBtn = document.createElement('button');
                recallBtn.classList.add('recall-btn');
                recallBtn.textContent = 'Êí§Âõû';
                recallBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    recallMessage(msgId);
                });
                bubbleDiv.appendChild(recallBtn);
            }

            wrapper.appendChild(headerDiv);
            wrapper.appendChild(bubbleDiv);
            messageContainer.appendChild(wrapper);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function addSystemMessage(text) {
            const sysDiv = document.createElement('div');
            sysDiv.classList.add('system-message');
            sysDiv.textContent = text;
            messageContainer.appendChild(sysDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function addCurrentUsersMessage() {
            const names = [];
            for (let [id, info] of onlineUsers) {
                const genderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '' }[info.gender] || '';
                names.push((info.anon ? 'ÂåøÂêç' : info.name) + genderSymbol);
            }
            const selfGenderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '' }[myGender] || '';
            const selfName = (isAnonymous ? 'ÂåøÂêç' : myName) + selfGenderSymbol + ' (‰Ω†)';
            names.push(selfName);
            addSystemMessage(`üë• ÂΩìÂâçÂú®Á∫øÔºö${names.join('„ÄÅ')}`);
        }

        function updatePeerCount() {
            peerCountDisplay.innerHTML = `${onlineUsers.size + 1} ‰∫∫Âú®Á∫ø`;
        }

        function recallMessage(msgId) {
            if (!msgId || !mySentMessages.has(msgId)) return;
            document.querySelectorAll(`[data-msgid="${msgId}"]`).forEach(el => el.remove());
            mySentMessages.delete(msgId);
            
            if (myId === FIXED_HUB_ID) {
                const idx = messageHistory.findIndex(m => m.msgId === msgId);
                if (idx !== -1) messageHistory.splice(idx, 1);
            }

            const recallPayload = { type: 'recall', msgId, originId: myId };
            for (let conn of connections.values()) if (conn.open) conn.send(recallPayload);
        }

        async function broadcastMessage(text) {
            const msgId = generateMsgId();
            let fileArray = null;
            if (pendingFiles.length > 0) {
                fileArray = await Promise.all(pendingFiles.map(async (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve({ name: file.name, type: file.type, data: e.target.result });
                        reader.readAsDataURL(file);
                    });
                }));
            }

            const messagePayload = {
                type: 'chat', msgId, text: text || '',
                sender: isAnonymous ? 'ÂåøÂêç' : myName,
                time: Date.now(), originId: myId,
                files: fileArray,
                senderAvatar: isAnonymous ? null : (myAvatarData || null),
                senderAnon: isAnonymous,
                senderGender: isAnonymous ? null : myGender,
                quote: quoteMessage ? { sender: quoteMessage.sender, text: quoteMessage.text } : null
            };

            if (myId === FIXED_HUB_ID) {
                if (!messageHistory.some(m => m.msgId === msgId)) {
                    messageHistory.push(messagePayload);
                    if (messageHistory.length > MAX_HISTORY) messageHistory.shift();
                }
            }

            mySentMessages.set(msgId, messagePayload);
            addMessageToUI(messagePayload, true);

            for (let conn of connections.values()) if (conn.open) try { conn.send(messagePayload); } catch(e) {}

            pendingFiles = [];
            updateFilePreview();
            // Ê∏ÖÁ©∫ÂºïÁî®
            quoteMessage = null;
            quotePreview.style.display = 'none';
        }

        // Ê†∏ÂøÉÊï∞ÊçÆÂ§ÑÁêÜ
        function handleData(conn, data) {
            if (data.type === 'chat') {
                if (data.originId === myId) return;

                if (myId === FIXED_HUB_ID) {
                    if (!messageHistory.some(m => m.msgId === data.msgId)) {
                        messageHistory.push(data);
                        if (messageHistory.length > MAX_HISTORY) messageHistory.shift();
                    }
                }

                if (!historyLoaded && myId !== FIXED_HUB_ID) {
                    if (!pendingMessages.some(m => m.msgId === data.msgId)) {
                        pendingMessages.push(data);
                    }
                    return;
                }

                addMessageToUI(data, false);

                for (let [peerId, otherConn] of connections) {
                    if (otherConn !== conn && otherConn.open) {
                        try { otherConn.send(data); } catch(e) {}
                    }
                }

            } else if (data.type === 'recall') {
                if (data.msgId) {
                    document.querySelectorAll(`[data-msgid="${data.msgId}"]`).forEach(el => el.remove());
                    if (myId === FIXED_HUB_ID) {
                        const idx = messageHistory.findIndex(m => m.msgId === data.msgId);
                        if (idx !== -1) messageHistory.splice(idx, 1);
                    }
                    for (let [peerId, otherConn] of connections) {
                        if (otherConn !== conn && otherConn.open) {
                            try { otherConn.send(data); } catch(e) {}
                        }
                    }
                }

            } else if (data.type === 'profileUpdate') {
                // Êõ¥Êñ∞Âú®Á∫øÁî®Êà∑‰ø°ÊÅØ
                const { originId, name, avatar, anon, gender, joinTime } = data;
                if (originId !== myId && onlineUsers.has(originId)) {
                    onlineUsers.set(originId, { name, avatar, anon, gender, joinTime });
                    // ÂèØÈÄâÔºöÊõ¥Êñ∞ÂàóË°®ÊòæÁ§∫
                }

            } else if (data.type === 'handshake') {
                const { originId, name, avatar, anon, gender } = data;
                const joinTime = Date.now();
                conn.metadata = conn.metadata || {};
                conn.metadata.remoteName = name;
                conn.metadata.remoteAvatar = avatar;
                conn.metadata.remoteAnon = anon || false;
                conn.metadata.remoteOriginId = originId;
                conn.metadata.remoteGender = gender || 'unknown';
                conn.metadata.joinTime = joinTime;

                if (myId === FIXED_HUB_ID) {
                    if (!onlineUsers.has(originId)) {
                        onlineUsers.set(originId, { name, avatar, anon, gender: gender || 'unknown', joinTime });
                        // ‰∏ªÊåÅ‰∫∫Á´ãÂç≥ÊòæÁ§∫Âä†ÂÖ•Ê∂àÊÅØ
                        const genderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '' }[gender] || '';
                        addSystemMessage(`‚û§ ${anon ? 'ÂåøÂêçÁî®Êà∑' : name}${genderSymbol} Âä†ÂÖ•‰∫ÜËÅäÂ§©`);
                        updatePeerCount();

                        const allUsers = Array.from(onlineUsers.entries()).map(([id, info]) => ({ id, ...info }));
                        allUsers.push({
                            id: myId,
                            name: myName,
                            avatar: myAvatarData,
                            anon: isAnonymous,
                            gender: myGender,
                            joinTime: window.selfJoinTime || Date.now()
                        });
                        conn.send({ type: 'system', subType: 'userList', users: allUsers, msgId: generateMsgId() });

                        if (messageHistory.length > 0) {
                            const historyCopy = messageHistory.map(m => ({ ...m }));
                            conn.send({ type: 'system', subType: 'history', messages: historyCopy, msgId: generateMsgId() });
                        }

                        for (let [peerId, otherConn] of connections) {
                            if (otherConn !== conn && otherConn.open) {
                                try {
                                    otherConn.send({
                                        type: 'system',
                                        subType: 'userJoin',
                                        user: { id: originId, name, avatar, anon, gender: gender || 'unknown', joinTime },
                                        msgId: generateMsgId()
                                    });
                                } catch(e) {}
                            }
                        }
                    }
                }

                if (conn.open) conn.send({ type: 'peerInfo', name: myName, avatar: myAvatarData, anon: isAnonymous, originId: myId, gender: myGender, joinTime: window.selfJoinTime || Date.now() });

            } else if (data.type === 'peerInfo') {
                conn.metadata = conn.metadata || {};
                conn.metadata.remoteName = data.name;
                conn.metadata.remoteAvatar = data.avatar;
                conn.metadata.remoteAnon = data.anon || false;
                conn.metadata.remoteOriginId = data.originId;
                conn.metadata.remoteGender = data.gender || 'unknown';
                conn.metadata.joinTime = data.joinTime;

            } else if (data.type === 'system') {
                if (data.subType === 'userList') {
                    const { users } = data;
                    onlineUsers.clear();
                    users.forEach(u => {
                        if (u.id && u.id !== myId) {
                            onlineUsers.set(u.id, { name: u.name, avatar: u.avatar, anon: u.anon, gender: u.gender || 'unknown', joinTime: u.joinTime });
                        }
                    });
                    updatePeerCount();

                } else if (data.subType === 'userJoin') {
                    const { user } = data;
                    if (user.id && user.id !== myId && !onlineUsers.has(user.id)) {
                        onlineUsers.set(user.id, { name: user.name, avatar: user.avatar, anon: user.anon, gender: user.gender || 'unknown', joinTime: user.joinTime });
                        updatePeerCount();
                        if (historyLoaded) {
                            const genderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '' }[user.gender] || '';
                            addSystemMessage(`‚û§ ${user.anon ? 'ÂåøÂêçÁî®Êà∑' : user.name}${genderSymbol} Âä†ÂÖ•‰∫ÜËÅäÂ§©`);
                        }
                    }

                } else if (data.subType === 'userLeave') {
                    const { userId } = data;
                    if (userId && userId !== myId && onlineUsers.has(userId)) {
                        const user = onlineUsers.get(userId);
                        onlineUsers.delete(userId);
                        updatePeerCount();
                        if (historyLoaded) {
                            const genderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '' }[user.gender] || '';
                            addSystemMessage(`‚úó ${user.anon ? 'ÂåøÂêçÁî®Êà∑' : user.name}${genderSymbol} Á¶ªÂºÄ‰∫ÜËÅäÂ§©`);
                        }
                    }
                } else if (data.subType === 'history') {
                    if (historyLoaded) return;
                    const messages = data.messages || [];
                    
                    messageContainer.innerHTML = '';
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.classList.add('system-message');
                    welcomeDiv.textContent = 'üëã Ê¨¢ËøéÊù•Âà∞20‰∏≠Â≠¶Âú®Á∫øËÅäÂ§©ÂÆ§';
                    messageContainer.appendChild(welcomeDiv);

                    const allMessages = [...messages, ...pendingMessages];
                    allMessages.sort((a,b) => (a.time || 0) - (b.time || 0));
                    allMessages.forEach(msg => {
                        addMessageToUI(msg, false);
                    });
                    pendingMessages = [];

                    historyLoaded = true;
                    addCurrentUsersMessage();
                }
            }
        }

        function setupConnection(conn) {
            const remoteId = conn.peer;
            if (connections.has(remoteId)) try { connections.get(remoteId).close(); } catch(e) {}
            connections.set(remoteId, conn);
            updatePeerCount();

            conn.on('data', (data) => handleData(conn, data));
            conn.on('close', () => {
                const remoteOriginId = conn.metadata?.remoteOriginId || conn.peer;
                const remoteName = conn.metadata?.remoteName || '‰∏Ä‰Ωç‰ºô‰º¥';
                const remoteAnon = conn.metadata?.remoteAnon || false;
                const remoteGender = conn.metadata?.remoteGender || 'unknown';

                if (myId === FIXED_HUB_ID) {
                    if (remoteOriginId && remoteOriginId !== myId && onlineUsers.has(remoteOriginId)) {
                        onlineUsers.delete(remoteOriginId);
                        const genderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '' }[remoteGender] || '';
                        addSystemMessage(`‚úó ${remoteAnon ? 'ÂåøÂêçÁî®Êà∑' : remoteName}${genderSymbol} Á¶ªÂºÄ‰∫ÜËÅäÂ§©`);
                        updatePeerCount();

                        for (let [peerId, otherConn] of connections) {
                            if (otherConn !== conn && otherConn.open) {
                                try {
                                    otherConn.send({
                                        type: 'system',
                                        subType: 'userLeave',
                                        userId: remoteOriginId,
                                        msgId: generateMsgId()
                                    });
                                } catch(e) {}
                            }
                        }
                    }
                } else {
                    if (remoteOriginId && remoteOriginId !== myId && onlineUsers.has(remoteOriginId)) {
                        onlineUsers.delete(remoteOriginId);
                        if (historyLoaded) {
                            const genderSymbol = { male: '‚ôÇ', female: '‚ôÄ', unknown: '' }[remoteGender] || '';
                            addSystemMessage(`‚úó ${remoteAnon ? 'ÂåøÂêçÁî®Êà∑' : remoteName}${genderSymbol} Á¶ªÂºÄ‰∫ÜËÅäÂ§©`);
                        }
                        updatePeerCount();
                    }
                }

                connections.delete(remoteId);
                updatePeerCount();
            });
            conn.on('error', () => {});

            setTimeout(() => {
                if (conn.open) conn.send({ type: 'handshake', name: myName, avatar: myAvatarData, anon: isAnonymous, originId: myId, gender: myGender });
            }, 150);
        }

        function connectToPeer(remoteId) {
            if (!peer || remoteId === myId || connections.has(remoteId)) return;
            const conn = peer.connect(remoteId, { reliable: true });
            conn.on('open', () => setupConnection(conn));
            conn.on('error', () => {});
        }

        function initPeer() {
            if (peer) peer.destroy();
            connections.clear();
            onlineUsers.clear();

            peer = new Peer(FIXED_HUB_ID, PEER_OPTIONS);
            peer.on('open', (id) => { 
                myId = id; 
                addSystemMessage('‚úÖ ‰Ω†Â∑≤ÂàõÂª∫ËÅäÂ§©ÂÆ§ (ÂºïÂØºËäÇÁÇπ)');
                if (myId === FIXED_HUB_ID) {
                    historyLoaded = true;
                    window.selfJoinTime = Date.now();
                }
            });
            peer.on('error', (err) => {
                if (err.type === 'unavailable-id' || (err.message && err.message.includes('ID'))) {
                    peer.destroy();
                    peer = new Peer(PEER_OPTIONS);
                    peer.on('open', (randomId) => {
                        myId = randomId;
                        addSystemMessage('üîÑ Âä†ÂÖ•Áé∞ÊúâËÅäÂ§©ÂÆ§ ...');
                        historyLoaded = false;
                        pendingMessages = [];
                        window.selfJoinTime = Date.now();
                        setTimeout(() => connectToPeer(FIXED_HUB_ID), 400);
                    });
                } else console.warn(err);
            });
            peer.on('connection', (conn) => setupConnection(conn));
            peer.on('disconnected', () => peer.reconnect());
        }
        initPeer();
        setInterval(updatePeerCount, 2000);

        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text && pendingFiles.length === 0 && !quoteMessage) return;
            await broadcastMessage(text);
            messageInput.value = '';
        });
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendButton.click(); });
    </script>
</body>
</html>
