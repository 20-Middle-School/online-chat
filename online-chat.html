<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>20‰∏≠Â≠¶Âú®Á∫øËÅäÂ§©ÂÆ§ ¬∑ Ê∏ÖÊñ∞P2P</title>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <style>
        /* Ê†∑Âºè‰øùÊåÅ‰∏çÂèòÔºà‰∏é‰∏ä‰∏Ä‰∏™ÁâàÊú¨Áõ∏ÂêåÔºâ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #e8f0fe;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', system-ui, sans-serif;
            padding: 12px;
            margin: 0;
            transition: background 0.2s, color 0.2s;
        }

        body.dark-mode {
            background: #1a2a36;
        }
        body.dark-mode .chat-container {
            background: rgba(25, 38, 48, 0.95);
            border-color: #2e5068;
        }
        body.dark-mode .header h1 {
            color: #e2efff;
        }
        body.dark-mode .header h1 span {
            background: #254b62;
            color: #cbe6fe;
            border-color: #3d6e8f;
        }
        body.dark-mode .peer-count,
        body.dark-mode .anon-checkbox,
        body.dark-mode .file-upload-label,
        body.dark-mode .theme-toggle {
            background: #243b4a;
            border-color: #3f6079;
            color: #e2f0ff;
        }
        
        body.dark-mode .nickname-group,
        body.dark-mode .avatar-group {
            background: #243b4a;
            border-color: #3f6079;
        }
        
        body.dark-mode .nickname-edit-btn {
            background: #2d4457;
            border-color: #3f6079;
            color: #e2f0ff;
        }
        
        body.dark-mode .avatar-selector {
            background: transparent;
            color: #e2f0ff;
        }
        
        body.dark-mode .reset-avatar-btn {
            background: #2d4457;
            color: #e2f0ff;
        }
        
        body.dark-mode .name-input {
            background: transparent;
            color: #e2f0ff;
        }
        body.dark-mode .name-input::placeholder {
            color: #9bb7d0;
        }
        
        body.dark-mode .peer-count::before {
            color: #6ae2a0;
        }
        body.dark-mode .messages-area {
            background: rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .message-bubble {
            background: #263f50;
            border-color: #386480;
            color: #eaf3fc;
        }
        body.dark-mode .message-self .message-bubble {
            background: #1e577a;
            border-color: #4790c0;
            color: #ffffff;
        }
        body.dark-mode .message-header .sender-name {
            color: #bddbff;
        }
        body.dark-mode .timestamp {
            color: #9ab9d6;
        }
        body.dark-mode .file-link,
        body.dark-mode .image-preview {
            background: #1c4057;
            border-color: #3674a0;
            color: #ddf0ff;
        }
        body.dark-mode .system-message {
            background: #1e4057;
            color: #cbe5ff;
            border-color: #3a74a0;
        }
        body.dark-mode .input-area {
            background: rgba(10, 30, 40, 0.7);
        }
        body.dark-mode .message-input {
            background: #1d3a4b;
            border-color: #36698b;
            color: #f0f8ff;
        }
        body.dark-mode .message-input::placeholder {
            color: #9abfda;
        }
        body.dark-mode .send-button {
            background: #2f73a0;
            box-shadow: 0 4px 12px #0f2e40;
            border-color: #7ab0d5;
        }
        body.dark-mode .file-tag {
            background: #254a5e;
            border-color: #3b78a0;
            color: #e2f0ff;
        }
        body.dark-mode .info-tip {
            color: #9fc9ec;
        }
        body.dark-mode .modal-content {
            background: #263f54;
            border-color: #3f79a0;
        }
        body.dark-mode .modal-title {
            color: #e2f0ff;
        }
        body.dark-mode .crop-btn {
            background: #2f6290;
            color: white;
            border-color: #4790c0;
        }
        body.dark-mode .crop-btn.primary {
            background: #3a7bb0;
            color: white;
        }

        .chat-container {
            max-width: 1200px;
            width: 100%;
            height: 90vh;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 38px;
            box-shadow: 0 20px 40px rgba(0, 40, 60, 0.2), 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.7);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.2s;
        }

        .header {
            padding: 16px 24px 8px 24px;
            border-bottom: 1px solid rgba(150, 180, 200, 0.2);
            flex-shrink: 0;
        }

        .logo-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .logo {
            width: 42px;
            height: 42px;
            background-color: #C46220;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(196, 98, 32, 0.3);
            flex-shrink: 0;
        }

        .logo-cross {
            width: 24px;
            height: 24px;
            position: relative;
        }

        .logo-cross::before,
        .logo-cross::after {
            content: '';
            position: absolute;
            background-color: #FFFFFF;
            border-radius: 8px;
        }

        .logo-cross::before {
            width: 24px;
            height: 4px;
            top: 10px;
            left: 0;
        }

        .logo-cross::after {
            width: 4px;
            height: 24px;
            left: 10px;
            top: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 400;
            color: #1a3d4c;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header h1 span {
            background: #d7ecff;
            font-size: 0.85rem;
            padding: 4px 14px;
            border-radius: 30px;
            color: #1f5775;
            font-weight: 300;
            border: 1px solid #aaccf0;
            white-space: nowrap;
        }

        .sub-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 6px;
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .peer-count {
            background: white;
            padding: 5px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            color: #1a4b64;
            border: 1px solid #bee0fa;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .peer-count::before {
            content: "‚óè";
            color: #2ea86b;
            font-size: 1.2rem;
        }

        .theme-toggle {
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 40px;
            padding: 5px 14px;
            font-size: 0.9rem;
            color: #1f5a7a;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .name-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .anon-checkbox {
            display: flex;
            align-items: center;
            background: white;
            padding: 5px 14px 5px 10px;
            border-radius: 30px;
            border: 1px solid #c7ddef;
            gap: 6px;
            font-size: 0.9rem;
            color: #1a4356;
            cursor: pointer;
            white-space: nowrap;
        }

        .anon-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: #3f9ed6;
            margin: 0;
        }

        .nickname-group {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            padding: 3px 3px 3px 16px;
            transition: background 0.2s, border-color 0.2s;
        }

        .name-input {
            background: transparent;
            border: none;
            padding: 6px 0;
            font-size: 0.95rem;
            color: #0f3448;
            outline: none;
            width: 110px;
            transition: color 0.2s;
        }

        .name-input:focus {
            outline: none;
        }

        .nickname-edit-btn {
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 30px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #1f5a7a;
            transition: 0.1s;
            flex-shrink: 0;
        }

        .nickname-edit-btn:hover {
            background: #e7f2fc;
        }

        .avatar-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            padding: 3px 3px 3px 6px;
            transition: background 0.2s, border-color 0.2s;
        }
        
        .avatar-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #1f5770;
            position: relative;
            white-space: nowrap;
            transition: color 0.2s;
        }
        
        .avatar-selector input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }
        
        .avatar-preview {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #d4e6f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border: 1px solid white;
            background-size: cover;
            background-position: center;
            z-index: 1;
            pointer-events: none;
            flex-shrink: 0;
        }
        
        .avatar-selector span {
            pointer-events: none;
            z-index: 1;
        }
        
        .reset-avatar-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #1f5a7a;
            flex-shrink: 0;
            transition: background 0.2s, color 0.2s;
        }

        .messages-area {
            flex: 1 1 auto;
            padding: 16px 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 14px;
            background: rgba(255,255,255,0.25);
            min-height: 0;
        }

        .message {
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.2s ease;
        }

        .message-self {
            align-self: flex-end;
        }

        .message-other {
            align-self: flex-start;
        }

        .message-bubble {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px 24px 24px 8px;
            padding: 10px 16px;
            color: #174257;
            line-height: 1.4;
            font-size: 0.95rem;
        }

        .message-self .message-bubble {
            background: #d1ecfe;
            border: 1px solid #b7defa;
            border-radius: 24px 24px 8px 24px;
            color: #05455c;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .msg-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #cee5f5;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: #2d5775;
            font-size: 0.85rem;
            border: 1px solid white;
        }

        .message-self .message-header {
            flex-direction: row-reverse;
        }

        .sender-name {
            font-weight: 600;
            color: #0f4a67;
            font-size: 0.85rem;
        }

        .timestamp {
            opacity: 0.6;
            font-size: 0.65rem;
            margin-left: 4px;
        }

        .message-body {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .file-attachment {
            margin-top: 6px;
            border-top: 1px dashed #aac8e0;
            padding-top: 6px;
        }

        .file-link, .image-preview {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.02);
            border-radius: 20px;
            padding: 5px 12px;
            text-decoration: none;
            color: #1d6185;
            border: 1px solid #cae0f0;
            font-size: 0.85rem;
        }

        .image-preview img {
            max-width: 160px;
            max-height: 160px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid white;
        }

        .recall-btn {
            background: transparent;
            border: none;
            color: #8ba0b5;
            font-size: 0.65rem;
            margin-left: 6px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 30px;
            opacity: 0.5;
        }

        .system-message {
            text-align: center;
            font-size: 0.75rem;
            color: #477e9e;
            background: rgba(215, 235, 250, 0.6);
            padding: 5px 16px;
            border-radius: 40px;
            align-self: center;
            border: 1px solid #c0dbf2;
            max-width: 90%;
        }

        .input-area {
            padding: 12px 24px 12px 24px;
            background: rgba(255,255,255,0.5);
            border-top: 1px solid rgba(150,180,200,0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .selected-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 36px;
            padding: 0 4px;
        }
        
        .file-tag {
            background: rgba(255,255,255,0.8);
            border-radius: 30px;
            padding: 4px 12px 4px 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #bedaf7;
            color: #05455c;
        }
        
        .file-tag .remove-file {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: #7a9cba;
            cursor: pointer;
            padding: 0 2px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .message-input {
            flex: 1 1 200px;
            min-width: 160px;
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 0.95rem;
            color: #0c3e55;
            outline: none;
        }
        
        .file-upload-label {
            background: white;
            border-radius: 40px;
            padding: 9px 18px;
            border: 1px solid #c7ddef;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #1f5a7a;
            font-size: 0.9rem;
            position: relative;
            white-space: nowrap;
        }
        
        .file-upload-label input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .send-button {
            background: #2d7fc1;
            border: none;
            border-radius: 60px;
            padding: 12px 28px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            border: 1px solid white;
            white-space: nowrap;
            transition: background 0.1s;
        }
        .send-button:hover {
            background: #1a6bb0;
        }

        .info-tip {
            color: #588cad;
            font-size: 0.75rem;
            padding: 0 24px 12px 24px;
            flex-shrink: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            padding: 24px;
            max-width: 480px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 14px;
            color: #174257;
        }
        .crop-container {
            max-height: 280px;
            margin-bottom: 18px;
        }
        #cropImage {
            max-width: 100%;
            max-height: 260px;
        }
        .crop-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .crop-btn {
            padding: 8px 22px;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            background: white;
            color: #1f5a7a;
            cursor: pointer;
            font-weight: 500;
            transition: 0.1s;
        }
        .crop-btn.primary {
            background: #2d7fc1;
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(45, 127, 193, 0.3);
        }
        .crop-btn.primary:hover {
            background: #1a6bb0;
        }

        #previewModal .modal-content {
            max-width: 800px;
            text-align: center;
        }
        #previewImage {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 700px) {
            body { padding: 8px; }
            .chat-container { height: 95vh; border-radius: 28px; }
            .header { padding: 12px 18px 6px 18px; }
            .logo-row { gap: 8px; }
            .logo { width: 36px; height: 36px; }
            .logo-cross { width: 20px; height: 20px; }
            .logo-cross::before { width: 20px; height: 3px; top: 8.5px; }
            .logo-cross::after { width: 3px; height: 20px; left: 8.5px; }
            .header h1 { font-size: 1.4rem; }
            .header h1 span { font-size: 0.75rem; padding: 3px 10px; }
            
            .sub-bar { flex-direction: column; align-items: stretch; }
            .left-controls { justify-content: space-between; }
            .name-section { justify-content: flex-start; }
            
            .nickname-group { padding-left: 12px; }
            .name-input { width: 90px; }
            
            .messages-area { padding: 12px 16px; }
            .message { max-width: 90%; }
            
            .input-area { padding: 10px 16px 10px 16px; }
            .input-row { gap: 8px; }
            .message-input { padding: 10px 16px; font-size: 0.9rem; }
            .file-upload-label { padding: 7px 14px; font-size: 0.85rem; }
            .send-button { padding: 10px 20px; font-size: 0.9rem; }
            .file-tag { font-size: 0.75rem; padding: 3px 10px; }
        }

        @media (max-width: 480px) {
            .name-section { gap: 8px; }
            .anon-checkbox { width: 100%; margin-bottom: 2px; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <div class="logo-row">
                <div class="logo">
                    <div class="logo-cross"></div>
                </div>
                <h1>
                    20‰∏≠Â≠¶Âú®Á∫øËÅäÂ§©ÂÆ§
                    <span>P2P Ê∏ÖÊñ∞Áâà</span>
                </h1>
            </div>
            <div class="sub-bar">
                <div class="left-controls">
                    <div class="peer-count" id="peerCountDisplay">0 ‰∫∫Âú®Á∫ø</div>
                    <div class="theme-toggle" id="themeToggleBtn">üåì Êó•Â§ú</div>
                </div>
                <div class="name-section">
                    <label class="anon-checkbox">
                        <input type="checkbox" id="anonCheckbox"> ÂåøÂêç
                    </label>
                    
                    <div class="nickname-group">
                        <input type="text" id="nicknameInput" class="name-input" placeholder="ÊòµÁß∞" maxlength="20" value="ÂêåÂ≠¶">
                        <div class="nickname-edit-btn" id="renameButton" title="Á°ÆËÆ§‰øÆÊîπÊòµÁß∞">‚úèÔ∏è</div>
                    </div>
                    
                    <div class="avatar-group">
                        <div class="avatar-selector" id="avatarSelector">
                            <div class="avatar-preview" id="avatarPreview">üì∑</div>
                            <span>Â§¥ÂÉè</span>
                            <input type="file" id="avatarUpload" accept="image/*">
                        </div>
                        <div class="reset-avatar-btn" id="resetAvatarBtn" title="ÊÅ¢Â§çÈªòËÆ§Â§¥ÂÉè">‚Ü∫</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="messages-area" id="messageContainer">
            <div class="system-message" id="welcomeMessage">üëã Ê¨¢Ëøé ¬∑ Â∏ÉÂ±Ä‰ºòÂåñ ¬∑ Â§¥ÂÉèÂèØË£ÅÂâ™</div>
        </div>

        <div class="input-area">
            <div class="selected-files" id="selectedFilesPreview"></div>
            <div class="input-row">
                <input type="text" id="messageInput" class="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                <label class="file-upload-label">
                    üìé Êñá‰ª∂
                    <input type="file" id="fileInput" multiple>
                </label>
                <button class="send-button" id="sendButton">ÂèëÈÄÅ</button>
            </div>
        </div>
        <div class="info-tip" id="infoTip">‚ú® Ë£ÅÂâ™Â§¥ÂÉè ¬∑ ÊÅ¢Â§çÈªòËÆ§ ¬∑ Ê∑±Ëâ≤Ê®°ÂºèÂ∑≤‰øÆÂ§ç</div>
    </div>

    <!-- Ë£ÅÂâ™Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="cropModal">
        <div class="modal-content">
            <div class="modal-title">‚úÇÔ∏è Ë£ÅÂâ™Â§¥ÂÉè</div>
            <div class="crop-container">
                <img id="cropImage" src="" alt="Ë£ÅÂâ™È¢ÑËßà">
            </div>
            <div class="crop-actions">
                <button class="crop-btn" id="cancelCrop">ÂèñÊ∂à</button>
                <button class="crop-btn primary" id="applyCrop">Â∫îÁî®</button>
            </div>
        </div>
    </div>

    <!-- ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-title">üñºÔ∏è ÂõæÁâáÈ¢ÑËßà</div>
            <div style="max-height: 70vh; overflow: auto; margin-bottom: 15px;">
                <img id="previewImage" src="" alt="È¢ÑËßà">
            </div>
            <div class="crop-actions">
                <button class="crop-btn" id="closePreview">ÂÖ≥Èó≠</button>
                <button class="crop-btn primary" id="saveImage">‰øùÂ≠òÂõæÁâá</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ---------- 20‰∏≠Â≠¶P2PËÅäÂ§©ÂÆ§ ¬∑ ÁªàÊûÅ‰øÆÂ§çÁâàÔºàÁ¶ªÂºÄÊèêÁ§∫100%ÂèØÈù†Ôºâ----------
        import Peer from 'https://esm.sh/peerjs@1.5.4?bundle-deps';
        import Cropper from 'https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/+esm';

        const PEER_OPTIONS = {
            config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] }
        };
        const FIXED_HUB_ID = '20zhongxue-p2p-hub-2026';

        let peer = null;
        let myId = null;
        let myName = 'ÂêåÂ≠¶' + Math.floor(Math.random() * 100);
        let isAnonymous = false;
        let myAvatarData = null;
        const connections = new Map();
        const mySentMessages = new Map();

        // Áî®‰∫éÂéªÈáçÂ∑≤Êé•Êî∂ÁöÑÊ∂àÊÅØIDÔºàÂåÖÊã¨ËÅäÂ§©ÂíåÁ≥ªÁªüÊ∂àÊÅØÔºâ
        const receivedMsgIds = new Set();

        // Âú®Á∫øÁî®Êà∑ÂàóË°®Ôºåkey = originId, value = { name, avatar, anon }
        const onlineUsers = new Map();

        let pendingFiles = [];

        // DOM ÂÖÉÁ¥†
        const messageContainer = document.getElementById('messageContainer');
        const peerCountDisplay = document.getElementById('peerCountDisplay');
        const nicknameInput = document.getElementById('nicknameInput');
        const renameButton = document.getElementById('renameButton');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const anonCheckbox = document.getElementById('anonCheckbox');
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarPreview = document.getElementById('avatarPreview');
        const fileInput = document.getElementById('fileInput');
        const selectedFilesPreview = document.getElementById('selectedFilesPreview');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const resetAvatarBtn = document.getElementById('resetAvatarBtn');

        const cropModal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');
        const cancelCrop = document.getElementById('cancelCrop');
        const applyCrop = document.getElementById('applyCrop');
        let cropper = null;

        const previewModal = document.getElementById('previewModal');
        const previewImage = document.getElementById('previewImage');
        const closePreview = document.getElementById('closePreview');
        const saveImage = document.getElementById('saveImage');

        nicknameInput.value = myName;

        // È¢ÑËßàÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
        closePreview.addEventListener('click', () => {
            previewModal.style.display = 'none';
        });
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) {
                previewModal.style.display = 'none';
            }
        });
        saveImage.addEventListener('click', () => {
            const imgSrc = previewImage.src;
            if (imgSrc) {
                const link = document.createElement('a');
                link.href = imgSrc;
                link.download = 'image_' + Date.now() + '.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // ÂõæÁâáÁÇπÂáªÂßîÊâòÔºöÈòªÊ≠¢Ë∑≥ËΩ¨Âπ∂ÂºπÂá∫È¢ÑËßà
        messageContainer.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'IMG' && target.closest('.image-preview')) {
                e.preventDefault();
                previewImage.src = target.src;
                previewModal.style.display = 'flex';
            }
        });

        function generateMsgId() { return Date.now() + '-' + Math.random().toString(36).substring(2,10); }

        function updateFilePreview() {
            if (!pendingFiles.length) { selectedFilesPreview.innerHTML = ''; return; }
            let html = '';
            pendingFiles.forEach((file, index) => {
                const name = file.name.length > 20 ? file.name.slice(0,17)+'...' : file.name;
                html += `<div class="file-tag">üìé ${escapeHTML(name)} (${(file.size/1024).toFixed(1)}KB)
                    <button class="remove-file" data-index="${index}">‚úï</button>
                </div>`;
            });
            selectedFilesPreview.innerHTML = html;
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.index);
                    pendingFiles.splice(idx, 1);
                    updateFilePreview();
                });
            });
        }
        function escapeHTML(str) { return String(str).replace(/[&<>"]/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

        fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);
            pendingFiles = [...pendingFiles, ...newFiles];
            updateFilePreview();
            fileInput.value = '';
        });

        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

        avatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                cropImage.src = ev.target.result;
                cropModal.style.display = 'flex';
                if (cropper) cropper.destroy();
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    cropBoxResizable: true,
                    background: false,
                });
            };
            reader.readAsDataURL(file);
            avatarUpload.value = '';
        });

        cancelCrop.addEventListener('click', () => {
            cropModal.style.display = 'none';
            if (cropper) { cropper.destroy(); cropper = null; }
        });

        applyCrop.addEventListener('click', () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 200, height: 200 });
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    myAvatarData = e.target.result;
                    avatarPreview.style.backgroundImage = `url('${myAvatarData}')`;
                    avatarPreview.textContent = '';
                    cropModal.style.display = 'none';
                    if (cropper) { cropper.destroy(); cropper = null; }
                };
                reader.readAsDataURL(blob);
            }, 'image/png');
        });

        resetAvatarBtn.addEventListener('click', () => {
            myAvatarData = null;
            avatarPreview.style.backgroundImage = '';
            avatarPreview.textContent = 'üì∑';
        });

        renameButton.addEventListener('click', () => {
            const newName = nicknameInput.value.trim();
            if (newName && newName !== myName) {
                myName = newName;
                addSystemMessage(`‚ú® ÊòµÁß∞Â∑≤‰øÆÊîπ‰∏∫ "${myName}"`);
            } else {
                nicknameInput.value = myName;
            }
        });

        nicknameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                renameButton.click();
            }
        });

        anonCheckbox.addEventListener('change', (e) => { isAnonymous = e.target.checked; });

        function addMessageToUI(msgData, isSelf = false) {
            const { msgId, text, sender, time, files, recalled, senderAvatar, senderAnon } = msgData;
            if (recalled) return;

            const wrapper = document.createElement('div');
            wrapper.classList.add('message');
            if (msgId) wrapper.setAttribute('data-msgid', msgId);
            if (isSelf) wrapper.classList.add('message-self');
            else wrapper.classList.add('message-other');

            const headerDiv = document.createElement('div');
            headerDiv.classList.add('message-header');

            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('msg-avatar');

            let displayName = sender;
            if (senderAnon === true) {
                displayName = 'ÂåøÂêç';
                avatarDiv.style.backgroundImage = '';
                avatarDiv.textContent = '?';
            } else {
                if (senderAvatar) {
                    avatarDiv.style.backgroundImage = `url('${senderAvatar}')`;
                    avatarDiv.textContent = '';
                } else {
                    avatarDiv.textContent = displayName.charAt(0).toUpperCase();
                }
            }

            const nameSpan = document.createElement('span');
            nameSpan.classList.add('sender-name');
            nameSpan.textContent = displayName;

            const timeSpan = document.createElement('span');
            timeSpan.classList.add('timestamp');
            timeSpan.textContent = time ? new Date(time).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : '';

            headerDiv.appendChild(avatarDiv);
            headerDiv.appendChild(nameSpan);
            headerDiv.appendChild(timeSpan);

            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('message-bubble');

            const bodyDiv = document.createElement('div');
            bodyDiv.classList.add('message-body');
            bodyDiv.textContent = text || '';

            bubbleDiv.appendChild(bodyDiv);

            if (files && files.length > 0) {
                const attachDiv = document.createElement('div');
                attachDiv.classList.add('file-attachment');
                files.forEach(f => {
                    if (f.type.startsWith('image/')) {
                        const imgWrap = document.createElement('a');
                        imgWrap.href = f.data;
                        imgWrap.target = '_blank';
                        imgWrap.classList.add('image-preview');
                        const img = document.createElement('img');
                        img.src = f.data;
                        img.alt = f.name;
                        imgWrap.appendChild(img);
                        attachDiv.appendChild(imgWrap);
                    } else {
                        const link = document.createElement('a');
                        link.href = f.data;
                        link.download = f.name;
                        link.classList.add('file-link');
                        link.textContent = `üìé ${f.name}`;
                        attachDiv.appendChild(link);
                    }
                });
                bubbleDiv.appendChild(attachDiv);
            }

            if (isSelf && msgId) {
                const recallBtn = document.createElement('button');
                recallBtn.classList.add('recall-btn');
                recallBtn.textContent = 'Êí§Âõû';
                recallBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    recallMessage(msgId);
                });
                bubbleDiv.appendChild(recallBtn);
            }

            wrapper.appendChild(headerDiv);
            wrapper.appendChild(bubbleDiv);
            messageContainer.appendChild(wrapper);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function addSystemMessage(text) {
            const sysDiv = document.createElement('div');
            sysDiv.classList.add('system-message');
            sysDiv.textContent = text;
            messageContainer.appendChild(sysDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function updatePeerCount() {
            peerCountDisplay.innerHTML = `${onlineUsers.size + 1} ‰∫∫Âú®Á∫ø`;
        }

        function recallMessage(msgId) {
            if (!msgId || !mySentMessages.has(msgId)) return;
            document.querySelectorAll(`[data-msgid="${msgId}"]`).forEach(el => el.remove());
            mySentMessages.delete(msgId);
            const recallPayload = { type: 'recall', msgId, originId: myId };
            for (let conn of connections.values()) if (conn.open) conn.send(recallPayload);
        }

        async function broadcastMessage(text) {
            const msgId = generateMsgId();
            let fileArray = null;
            if (pendingFiles.length > 0) {
                fileArray = await Promise.all(pendingFiles.map(async (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve({ name: file.name, type: file.type, data: e.target.result });
                        reader.readAsDataURL(file);
                    });
                }));
            }

            const messagePayload = {
                type: 'chat', msgId, text: text || '',
                sender: isAnonymous ? 'ÂåøÂêç' : myName,
                time: Date.now(), originId: myId,
                files: fileArray,
                senderAvatar: isAnonymous ? null : (myAvatarData || null),
                senderAnon: isAnonymous
            };

            mySentMessages.set(msgId, messagePayload);
            addMessageToUI(messagePayload, true);

            for (let conn of connections.values()) if (conn.open) try { conn.send(messagePayload); } catch(e) {}

            pendingFiles = [];
            updateFilePreview();
        }

        // Ê†∏ÂøÉÊï∞ÊçÆÂ§ÑÁêÜ
        function handleData(conn, data) {
            // ÊâÄÊúâÊ∂àÊÅØÈÉΩËøõË°åÂéªÈáçÔºàÈô§‰∫ÜÊüê‰∫õÁâπÊÆäÁ±ªÂûãÂ¶Ç handshake ÂèØËÉΩ‰∏çÈúÄË¶ÅÔºâ
            if (data.msgId && receivedMsgIds.has(data.msgId)) {
                return;
            }
            if (data.msgId) {
                receivedMsgIds.add(data.msgId);
            }

            if (data.type === 'chat') {
                // ÈÄöËøáÊ∂àÊÅØË°•ÂÖÖÂú®Á∫øÁî®Êà∑ÔºàÁ°Æ‰øùÁ¶ªÂºÄÊèêÁ§∫ËÉΩÊ≠£Â∏∏Â∑•‰ΩúÔºâ
                if (data.originId && data.originId !== myId && !onlineUsers.has(data.originId)) {
                    onlineUsers.set(data.originId, {
                        name: data.sender || 'Êú™Áü•',
                        avatar: data.senderAvatar || null,
                        anon: data.senderAnon || false
                    });
                    updatePeerCount();
                }

                if (!data.recalled) addMessageToUI(data, false);

                // ËΩ¨ÂèëÁªôÂÖ∂‰ªñÊâÄÊúâËøûÊé•
                for (let [peerId, otherConn] of connections) {
                    if (otherConn !== conn && otherConn.open) {
                        try { otherConn.send(data); } catch(e) {}
                    }
                }

            } else if (data.type === 'recall') {
                if (data.msgId) {
                    document.querySelectorAll(`[data-msgid="${data.msgId}"]`).forEach(el => el.remove());
                    for (let [peerId, otherConn] of connections) {
                        if (otherConn !== conn && otherConn.open) {
                            try { otherConn.send(data); } catch(e) {}
                        }
                    }
                }

            } else if (data.type === 'handshake') {
                const { originId, name, avatar, anon } = data;
                conn.metadata = conn.metadata || {};
                conn.metadata.remoteName = name;
                conn.metadata.remoteAvatar = avatar;
                conn.metadata.remoteAnon = anon || false;
                conn.metadata.remoteOriginId = originId;

                if (originId && originId !== myId && !onlineUsers.has(originId)) {
                    onlineUsers.set(originId, { name, avatar, anon });
                    addSystemMessage(`‚û§ ${anon ? 'ÂåøÂêçÁî®Êà∑' : name} Âä†ÂÖ•‰∫ÜËÅäÂ§©`);
                    updatePeerCount();
                }

                // ‰∏ªÊåÅ‰∫∫Â§ÑÁêÜ
                if (myId === FIXED_HUB_ID) {
                    // ÊûÑÂª∫ÂåÖÂê´ÊâÄÊúâÂú®Á∫øÁî®Êà∑ÔºàÂåÖÊã¨‰∏ªÊåÅ‰∫∫Ëá™Â∑±ÔºâÁöÑÂàóË°®ÔºåÂèëÁªôÊñ∞Áî®Êà∑
                    const allUsers = Array.from(onlineUsers.entries()).map(([id, info]) => ({ id, ...info }));
                    // Âä†‰∏ä‰∏ªÊåÅ‰∫∫Ëá™Â∑±Ôºà‰∏ªÊåÅ‰∫∫‰∏çÂåÖÂê´Âú® onlineUsers ‰∏≠Ôºâ
                    allUsers.push({
                        id: myId,
                        name: myName,
                        avatar: myAvatarData,
                        anon: isAnonymous
                    });
                    // ËøáÊª§ÊéâÊñ∞Áî®Êà∑Ëá™Â∑±ÔºàËôΩÁÑ∂Êñ∞Áî®Êà∑ÂèØËÉΩÂ∑≤Âú® onlineUsers ‰∏≠Ôºå‰ΩÜËøáÊª§‰ª•Èò≤ÈáçÂ§çÔºâ
                    const otherUsers = allUsers.filter(u => u.id !== originId);
                    if (otherUsers.length > 0) {
                        conn.send({ type: 'system', subType: 'userList', users: otherUsers });
                    }

                    // ÂêëÂÖ∂‰ªñÁî®Êà∑ÂπøÊí≠Êñ∞Áî®Êà∑Âä†ÂÖ•
                    for (let [peerId, otherConn] of connections) {
                        if (otherConn !== conn && otherConn.open) {
                            try {
                                otherConn.send({
                                    type: 'system',
                                    subType: 'userJoin',
                                    user: { id: originId, name, avatar, anon }
                                });
                            } catch(e) {}
                        }
                    }
                }

                // ÂõûÂ§çËá™Â∑±ÁöÑ‰ø°ÊÅØ
                if (conn.open) conn.send({ type: 'peerInfo', name: myName, avatar: myAvatarData, anon: isAnonymous, originId: myId });

            } else if (data.type === 'peerInfo') {
                conn.metadata = conn.metadata || {};
                conn.metadata.remoteName = data.name;
                conn.metadata.remoteAvatar = data.avatar;
                conn.metadata.remoteAnon = data.anon || false;
                conn.metadata.remoteOriginId = data.originId;
                // Á°Æ‰øùÁî®Êà∑Âú®Âú®Á∫øÂàóË°®‰∏≠
                if (data.originId && data.originId !== myId && !onlineUsers.has(data.originId)) {
                    onlineUsers.set(data.originId, { name: data.name, avatar: data.avatar, anon: data.anon });
                    updatePeerCount();
                }

            } else if (data.type === 'system') {
                if (data.subType === 'userList') {
                    const { users } = data;
                    users.forEach(u => {
                        if (u.id && u.id !== myId && !onlineUsers.has(u.id)) {
                            onlineUsers.set(u.id, { name: u.name, avatar: u.avatar, anon: u.anon });
                        }
                    });
                    updatePeerCount();

                    // ÁîüÊàêÂú®Á∫øÁî®Êà∑ÊòµÁß∞ÂàóË°®ÔºàÁî®‰∫éÊòæÁ§∫Ôºâ
                    const names = [];
                    for (let [id, info] of onlineUsers) {
                        names.push(info.anon ? 'ÂåøÂêçÁî®Êà∑' : (info.name || 'Êú™Áü•'));
                    }
                    const selfName = isAnonymous ? 'ÂåøÂêçÁî®Êà∑' : myName;
                    names.push(selfName + ' (‰Ω†)');
                    addSystemMessage(`üë• ÂΩìÂâçÂú®Á∫øÔºö${names.join('„ÄÅ')}`);

                } else if (data.subType === 'userJoin') {
                    const { user } = data;
                    if (user.id && user.id !== myId && !onlineUsers.has(user.id)) {
                        onlineUsers.set(user.id, { name: user.name, avatar: user.avatar, anon: user.anon });
                        addSystemMessage(`‚û§ ${user.anon ? 'ÂåøÂêçÁî®Êà∑' : user.name} Âä†ÂÖ•‰∫ÜËÅäÂ§©`);
                        updatePeerCount();
                    }

                } else if (data.subType === 'userLeave') {
                    const { userId } = data;
                    if (userId && userId !== myId && onlineUsers.has(userId)) {
                        const user = onlineUsers.get(userId);
                        onlineUsers.delete(userId);
                        addSystemMessage(`‚úó ${user.anon ? 'ÂåøÂêçÁî®Êà∑' : user.name} Á¶ªÂºÄ‰∫ÜËÅäÂ§©`);
                        updatePeerCount();
                    }
                }

            } else if (data.type === 'leave') {
                // Â§ÑÁêÜÁ¶ªÂºÄÊ∂àÊÅØÔºàÁî±Êñ≠ÂºÄËøûÊé•ÁöÑ‰∏ÄÊñπÂπøÊí≠Ôºâ
                const { userId, name, anon } = data;
                if (userId && userId !== myId && onlineUsers.has(userId)) {
                    onlineUsers.delete(userId);
                    addSystemMessage(`‚úó ${anon ? 'ÂåøÂêçÁî®Êà∑' : name} Á¶ªÂºÄ‰∫ÜËÅäÂ§©`);
                    updatePeerCount();
                }
                // ‰∏çËΩ¨ÂèëÔºåÂõ†‰∏∫ÂπøÊí≠Â∑≤ÁªèÂèëÈÄÅÁªôÊâÄÊúâÂú®Á∫øËäÇÁÇπ
            }
        }

        function setupConnection(conn) {
            const remoteId = conn.peer;
            if (connections.has(remoteId)) try { connections.get(remoteId).close(); } catch(e) {}
            connections.set(remoteId, conn);
            updatePeerCount();

            conn.on('data', (data) => handleData(conn, data));
            conn.on('close', () => {
                // Ëé∑ÂèñÊñ≠ÂºÄËøûÊé•ÁöÑÁî®Êà∑‰ø°ÊÅØÔºà‰ªémetadata‰∏≠Ôºâ
                const remoteOriginId = conn.metadata?.remoteOriginId || conn.peer;
                const remoteName = conn.metadata?.remoteName || '‰∏Ä‰Ωç‰ºô‰º¥';
                const remoteAnon = conn.metadata?.remoteAnon || false;

                // Â¶ÇÊûúËØ•Áî®Êà∑ËøòÂú®Âú®Á∫øÂàóË°®‰∏≠ÔºåÂàôÁßªÈô§Âπ∂ÂπøÊí≠Á¶ªÂºÄÊ∂àÊÅØ
                if (remoteOriginId && remoteOriginId !== myId && onlineUsers.has(remoteOriginId)) {
                    onlineUsers.delete(remoteOriginId);
                    addSystemMessage(`‚úó ${remoteAnon ? 'ÂåøÂêçÁî®Êà∑' : remoteName} Á¶ªÂºÄ‰∫ÜËÅäÂ§©`);
                    updatePeerCount();

                    // ÊûÑÈÄ†Á¶ªÂºÄÊ∂àÊÅØÔºåÂπøÊí≠ÁªôÊâÄÊúâÂÖ∂‰ªñËøûÊé•
                    const leaveMsgId = 'leave-' + Date.now() + '-' + remoteOriginId;
                    const leavePayload = {
                        type: 'leave',
                        msgId: leaveMsgId,
                        userId: remoteOriginId,
                        name: remoteName,
                        anon: remoteAnon
                    };
                    for (let [peerId, otherConn] of connections) {
                        if (otherConn !== conn && otherConn.open) {
                            try {
                                otherConn.send(leavePayload);
                            } catch(e) {}
                        }
                    }
                }

                connections.delete(remoteId);
                updatePeerCount();
            });
            conn.on('error', () => {});

            setTimeout(() => {
                if (conn.open) conn.send({ type: 'handshake', name: myName, avatar: myAvatarData, anon: isAnonymous, originId: myId });
            }, 150);
        }

        function connectToPeer(remoteId) {
            if (!peer || remoteId === myId || connections.has(remoteId)) return;
            const conn = peer.connect(remoteId, { reliable: true });
            conn.on('open', () => setupConnection(conn));
            conn.on('error', () => {});
        }

        function initPeer() {
            if (peer) peer.destroy();
            connections.clear();
            onlineUsers.clear();

            peer = new Peer(FIXED_HUB_ID, PEER_OPTIONS);
            peer.on('open', (id) => { 
                myId = id; 
                addSystemMessage('‚úÖ ‰Ω†Â∑≤ÂàõÂª∫ËÅäÂ§©ÂÆ§ (ÂºïÂØºËäÇÁÇπ)');
            });
            peer.on('error', (err) => {
                if (err.type === 'unavailable-id' || (err.message && err.message.includes('ID'))) {
                    peer.destroy();
                    peer = new Peer(PEER_OPTIONS);
                    peer.on('open', (randomId) => {
                        myId = randomId;
                        addSystemMessage('üîÑ Âä†ÂÖ•Áé∞ÊúâËÅäÂ§©ÂÆ§ ...');
                        setTimeout(() => connectToPeer(FIXED_HUB_ID), 400);
                    });
                } else console.warn(err);
            });
            peer.on('connection', (conn) => setupConnection(conn));
            peer.on('disconnected', () => peer.reconnect());
        }
        initPeer();
        setInterval(updatePeerCount, 2000);

        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text && pendingFiles.length === 0) return;
            await broadcastMessage(text);
            messageInput.value = '';
        });
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendButton.click(); });
    </script>
</body>
</html>
