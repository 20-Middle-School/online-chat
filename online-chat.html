<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>20‰∏≠Â≠¶Âú®Á∫øËÅäÂ§©ÂÆ§ ¬∑ Ê∏ÖÊñ∞P2P</title>
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
    <style>
        /* Ê†∑Âºè‰øùÊåÅ‰∏çÂèò */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #e8f0fe;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', system-ui, sans-serif;
            padding: 12px;
            margin: 0;
            transition: background 0.2s, color 0.2s;
        }

        body.dark-mode {
            background: #1a2a36;
        }
        body.dark-mode .chat-container {
            background: rgba(25, 38, 48, 0.95);
            border-color: #2e5068;
        }
        body.dark-mode .header h1 {
            color: #e2efff;
        }
        body.dark-mode .header h1 span {
            background: #254b62;
            color: #cbe6fe;
            border-color: #3d6e8f;
        }
        body.dark-mode .peer-count,
        body.dark-mode .anon-checkbox,
        body.dark-mode .file-upload-label,
        body.dark-mode .theme-toggle {
            background: #243b4a;
            border-color: #3f6079;
            color: #e2f0ff;
        }
        
        body.dark-mode .nickname-group,
        body.dark-mode .avatar-group {
            background: #243b4a;
            border-color: #3f6079;
        }
        
        body.dark-mode .nickname-edit-btn {
            background: #2d4457;
            border-color: #3f6079;
            color: #e2f0ff;
        }
        
        body.dark-mode .avatar-selector {
            background: transparent;
            color: #e2f0ff;
        }
        
        body.dark-mode .reset-avatar-btn {
            background: #2d4457;
            color: #e2f0ff;
        }
        
        body.dark-mode .name-input {
            background: transparent;
            color: #e2f0ff;
        }
        body.dark-mode .name-input::placeholder {
            color: #9bb7d0;
        }
        
        body.dark-mode .peer-count::before {
            color: #6ae2a0;
        }
        body.dark-mode .messages-area {
            background: rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .message-bubble {
            background: #263f50;
            border-color: #386480;
            color: #eaf3fc;
        }
        body.dark-mode .message-self .message-bubble {
            background: #1e577a;
            border-color: #4790c0;
            color: #ffffff;
        }
        body.dark-mode .message-header .sender-name {
            color: #bddbff;
        }
        body.dark-mode .timestamp {
            color: #9ab9d6;
        }
        body.dark-mode .file-link,
        body.dark-mode .image-preview {
            background: #1c4057;
            border-color: #3674a0;
            color: #ddf0ff;
        }
        body.dark-mode .system-message {
            background: #1e4057;
            color: #cbe5ff;
            border-color: #3a74a0;
        }
        body.dark-mode .input-area {
            background: rgba(10, 30, 40, 0.7);
        }
        body.dark-mode .message-input {
            background: #1d3a4b;
            border-color: #36698b;
            color: #f0f8ff;
        }
        body.dark-mode .message-input::placeholder {
            color: #9abfda;
        }
        body.dark-mode .send-button {
            background: #2f73a0;
            box-shadow: 0 4px 12px #0f2e40;
            border-color: #7ab0d5;
        }
        body.dark-mode .file-tag {
            background: #254a5e;
            border-color: #3b78a0;
            color: #e2f0ff;
        }
        body.dark-mode .info-tip {
            color: #9fc9ec;
        }
        body.dark-mode .modal-content {
            background: #263f54;
            border-color: #3f79a0;
        }
        body.dark-mode .modal-title {
            color: #e2f0ff;
        }
        body.dark-mode .crop-btn {
            background: #2f6290;
            color: white;
            border-color: #4790c0;
        }
        body.dark-mode .crop-btn.primary {
            background: #3a7bb0;
            color: white;
        }
        body.dark-mode .preview-modal-content {
            background: #1e3645;
            border-color: #3a6a8a;
        }
        body.dark-mode .preview-sender {
            color: #e2f0ff;
        }
        body.dark-mode .preview-close,
        body.dark-mode .preview-download {
            background: #2d4a60;
            color: #e2f0ff;
            border-color: #3f6e8c;
        }
        body.dark-mode .preview-close:hover,
        body.dark-mode .preview-download:hover {
            background: #3d6080;
        }

        .chat-container {
            max-width: 1200px;
            width: 100%;
            height: 90vh;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 38px;
            box-shadow: 0 20px 40px rgba(0, 40, 60, 0.2), 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.7);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.2s;
        }

        .header {
            padding: 16px 24px 8px 24px;
            border-bottom: 1px solid rgba(150, 180, 200, 0.2);
            flex-shrink: 0;
        }

        .logo-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .logo {
            width: 42px;
            height: 42px;
            background-color: #C46220;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(196, 98, 32, 0.3);
            flex-shrink: 0;
        }

        .logo-cross {
            width: 24px;
            height: 24px;
            position: relative;
        }

        .logo-cross::before,
        .logo-cross::after {
            content: '';
            position: absolute;
            background-color: #FFFFFF;
            border-radius: 8px;
        }

        .logo-cross::before {
            width: 24px;
            height: 4px;
            top: 10px;
            left: 0;
        }

        .logo-cross::after {
            width: 4px;
            height: 24px;
            left: 10px;
            top: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 400;
            color: #1a3d4c;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header h1 span {
            background: #d7ecff;
            font-size: 0.85rem;
            padding: 4px 14px;
            border-radius: 30px;
            color: #1f5775;
            font-weight: 300;
            border: 1px solid #aaccf0;
            white-space: nowrap;
        }

        .sub-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 6px;
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .peer-count {
            background: white;
            padding: 5px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            color: #1a4b64;
            border: 1px solid #bee0fa;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .peer-count::before {
            content: "‚óè";
            color: #2ea86b;
            font-size: 1.2rem;
        }

        .theme-toggle {
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 40px;
            padding: 5px 14px;
            font-size: 0.9rem;
            color: #1f5a7a;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .name-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .anon-checkbox {
            display: flex;
            align-items: center;
            background: white;
            padding: 5px 14px 5px 10px;
            border-radius: 30px;
            border: 1px solid #c7ddef;
            gap: 6px;
            font-size: 0.9rem;
            color: #1a4356;
            cursor: pointer;
            white-space: nowrap;
        }

        .anon-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: #3f9ed6;
            margin: 0;
        }

        .nickname-group {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            padding: 3px 3px 3px 16px;
            transition: background 0.2s, border-color 0.2s;
        }

        .name-input {
            background: transparent;
            border: none;
            padding: 6px 0;
            font-size: 0.95rem;
            color: #0f3448;
            outline: none;
            width: 110px;
            transition: color 0.2s;
        }

        .name-input:focus {
            outline: none;
        }

        .nickname-edit-btn {
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 30px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #1f5a7a;
            transition: 0.1s;
            flex-shrink: 0;
        }

        .nickname-edit-btn:hover {
            background: #e7f2fc;
        }

        .avatar-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            padding: 3px 3px 3px 6px;
            transition: background 0.2s, border-color 0.2s;
        }
        
        .avatar-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #1f5770;
            position: relative;
            white-space: nowrap;
            transition: color 0.2s;
        }
        
        .avatar-selector input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }
        
        .avatar-preview {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #d4e6f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border: 1px solid white;
            background-size: cover;
            background-position: center;
            z-index: 1;
            pointer-events: none;
            flex-shrink: 0;
        }
        
        .avatar-selector span {
            pointer-events: none;
            z-index: 1;
        }
        
        .reset-avatar-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #1f5a7a;
            flex-shrink: 0;
            transition: background 0.2s, color 0.2s;
        }

        .messages-area {
            flex: 1 1 auto;
            padding: 16px 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 14px;
            background: rgba(255,255,255,0.25);
            min-height: 0;
        }

        .message {
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.2s ease;
        }

        .message-self {
            align-self: flex-end;
        }

        .message-other {
            align-self: flex-start;
        }

        .message-bubble {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px 24px 24px 8px;
            padding: 10px 16px;
            color: #174257;
            line-height: 1.4;
            font-size: 0.95rem;
        }

        .message-self .message-bubble {
            background: #d1ecfe;
            border: 1px solid #b7defa;
            border-radius: 24px 24px 8px 24px;
            color: #05455c;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .msg-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #cee5f5;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: #2d5775;
            font-size: 0.85rem;
            border: 1px solid white;
        }

        .message-self .message-header {
            flex-direction: row-reverse;
        }

        .sender-name {
            font-weight: 600;
            color: #0f4a67;
            font-size: 0.85rem;
        }

        .timestamp {
            opacity: 0.6;
            font-size: 0.65rem;
            margin-left: 4px;
        }

        .message-body {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .file-attachment {
            margin-top: 6px;
            border-top: 1px dashed #aac8e0;
            padding-top: 6px;
        }

        .file-link, .image-preview {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.02);
            border-radius: 20px;
            padding: 5px 12px;
            text-decoration: none;
            color: #1d6185;
            border: 1px solid #cae0f0;
            font-size: 0.85rem;
        }

        .image-preview img {
            max-width: 160px;
            max-height: 160px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid white;
        }

        .recall-btn {
            background: transparent;
            border: none;
            color: #8ba0b5;
            font-size: 0.65rem;
            margin-left: 6px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 30px;
            opacity: 0.5;
        }

        .recall-btn:hover {
            opacity: 1;
            background: rgba(200, 225, 245, 0.5);
        }

        .system-message {
            text-align: center;
            font-size: 0.75rem;
            color: #477e9e;
            background: rgba(215, 235, 250, 0.6);
            padding: 5px 16px;
            border-radius: 40px;
            align-self: center;
            border: 1px solid #c0dbf2;
            max-width: 90%;
        }

        .input-area {
            padding: 12px 24px 12px 24px;
            background: rgba(255,255,255,0.5);
            border-top: 1px solid rgba(150,180,200,0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .selected-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 36px;
            padding: 0 4px;
        }
        
        .file-tag {
            background: rgba(255,255,255,0.8);
            border-radius: 30px;
            padding: 4px 12px 4px 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #bedaf7;
            color: #05455c;
        }
        
        .file-tag .remove-file {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: #7a9cba;
            cursor: pointer;
            padding: 0 2px;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .message-input {
            flex: 1 1 200px;
            min-width: 160px;
            background: white;
            border: 1px solid #c7ddef;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 0.95rem;
            color: #0c3e55;
            outline: none;
        }
        
        .file-upload-label {
            background: white;
            border-radius: 40px;
            padding: 9px 18px;
            border: 1px solid #c7ddef;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #1f5a7a;
            font-size: 0.9rem;
            position: relative;
            white-space: nowrap;
        }
        
        .file-upload-label input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .send-button {
            background: #8fc8f0;
            border: none;
            border-radius: 60px;
            padding: 12px 28px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            border: 1px solid white;
            white-space: nowrap;
        }

        .info-tip {
            color: #588cad;
            font-size: 0.75rem;
            padding: 0 24px 12px 24px;
            flex-shrink: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            padding: 24px;
            max-width: 480px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 14px;
            color: #174257;
        }
        .crop-container {
            max-height: 280px;
            margin-bottom: 18px;
        }
        #cropImage {
            max-width: 100%;
            max-height: 260px;
        }
        .crop-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .crop-btn {
            padding: 8px 22px;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            background: white;
            color: #1f5a7a;
            cursor: pointer;
            font-weight: 500;
            transition: 0.1s;
        }
        .crop-btn.primary {
            background: #2d7fc1;
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(45, 127, 193, 0.3);
        }
        .crop-btn.primary:hover {
            background: #1a6bb0;
        }

        /* ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .preview-modal-content {
            max-width: 90vw;
            max-height: 90vh;
            background: white;
            border-radius: 24px;
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .preview-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .preview-image {
            max-width: 80vw;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 12px;
        }
        .preview-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #e0eefc;
        }
        .preview-sender {
            font-size: 0.9rem;
            color: #174257;
        }
        .preview-actions {
            display: flex;
            gap: 12px;
        }
        .preview-close, .preview-download {
            padding: 8px 20px;
            border-radius: 40px;
            border: 1px solid #c7ddef;
            background: white;
            color: #1f5a7a;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.1s;
        }
        .preview-close:hover, .preview-download:hover {
            background: #e7f2fc;
        }
        .preview-download {
            background: #2d7fc1;
            color: white;
            border: none;
        }
        .preview-download:hover {
            background: #1a6bb0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 700px) {
            body { padding: 8px; }
            .chat-container { height: 95vh; border-radius: 28px; }
            .header { padding: 12px 18px 6px 18px; }
            .logo-row { gap: 8px; }
            .logo { width: 36px; height: 36px; }
            .logo-cross { width: 20px; height: 20px; }
            .logo-cross::before { width: 20px; height: 3px; top: 8.5px; }
            .logo-cross::after { width: 3px; height: 20px; left: 8.5px; }
            .header h1 { font-size: 1.4rem; }
            .header h1 span { font-size: 0.75rem; padding: 3px 10px; }
            
            .sub-bar { flex-direction: column; align-items: stretch; }
            .left-controls { justify-content: space-between; }
            .name-section { justify-content: flex-start; }
            
            .nickname-group { padding-left: 12px; }
            .name-input { width: 90px; }
            
            .messages-area { padding: 12px 16px; }
            .message { max-width: 90%; }
            
            .input-area { padding: 10px 16px 10px 16px; }
            .input-row { gap: 8px; }
            .message-input { padding: 10px 16px; font-size: 0.9rem; }
            .file-upload-label { padding: 7px 14px; font-size: 0.85rem; }
            .send-button { padding: 10px 20px; font-size: 0.9rem; }
            .file-tag { font-size: 0.75rem; padding: 3px 10px; }
            
            .preview-modal-content { padding: 12px; }
            .preview-image { max-width: 85vw; max-height: 65vh; }
        }

        @media (max-width: 480px) {
            .name-section { gap: 8px; }
            .anon-checkbox { width: 100%; margin-bottom: 2px; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <div class="logo-row">
                <div class="logo">
                    <div class="logo-cross"></div>
                </div>
                <h1>
                    20‰∏≠Â≠¶Âú®Á∫øËÅäÂ§©ÂÆ§
                    <span>P2P Êñá‰ª∂‰øÆÂ§çÁâà</span>
                </h1>
            </div>
            <div class="sub-bar">
                <div class="left-controls">
                    <div class="peer-count" id="peerCountDisplay">0 ‰∫∫Âú®Á∫ø</div>
                    <div class="theme-toggle" id="themeToggleBtn">üåì Êó•Â§ú</div>
                </div>
                <div class="name-section">
                    <label class="anon-checkbox">
                        <input type="checkbox" id="anonCheckbox"> ÂåøÂêç
                    </label>
                    
                    <div class="nickname-group">
                        <input type="text" id="nicknameInput" class="name-input" placeholder="ÊòµÁß∞" maxlength="20" value="ÂêåÂ≠¶">
                        <div class="nickname-edit-btn" id="renameButton" title="Á°ÆËÆ§‰øÆÊîπÊòµÁß∞">‚úèÔ∏è</div>
                    </div>
                    
                    <div class="avatar-group">
                        <div class="avatar-selector" id="avatarSelector">
                            <div class="avatar-preview" id="avatarPreview">üì∑</div>
                            <span>Â§¥ÂÉè</span>
                            <input type="file" id="avatarUpload" accept="image/*">
                        </div>
                        <div class="reset-avatar-btn" id="resetAvatarBtn" title="ÊÅ¢Â§çÈªòËÆ§Â§¥ÂÉè">‚Ü∫</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="messages-area" id="messageContainer">
            <div class="system-message" id="welcomeMessage">üëã Ê¨¢Ëøé ¬∑ Êñá‰ª∂‰º†ËæìÂ∑≤‰øÆÂ§ç</div>
        </div>

        <div class="input-area">
            <div class="selected-files" id="selectedFilesPreview"></div>
            <div class="input-row">
                <input type="text" id="messageInput" class="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                <label class="file-upload-label">
                    üìé Êñá‰ª∂
                    <input type="file" id="fileInput" multiple>
                </label>
                <button class="send-button" id="sendButton">ÂèëÈÄÅ</button>
            </div>
        </div>
        <div class="info-tip" id="infoTip">‚ú® Êñá‰ª∂/ÂõæÁâáÁé∞Âú®ÂèØ‰ª•Ê≠£Â∏∏Êé•Êî∂</div>
    </div>

    <!-- Ë£ÅÂâ™Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="cropModal">
        <div class="modal-content">
            <div class="modal-title">‚úÇÔ∏è Ë£ÅÂâ™Â§¥ÂÉè</div>
            <div class="crop-container">
                <img id="cropImage" src="" alt="Ë£ÅÂâ™È¢ÑËßà">
            </div>
            <div class="crop-actions">
                <button class="crop-btn" id="cancelCrop">ÂèñÊ∂à</button>
                <button class="crop-btn primary" id="applyCrop">Â∫îÁî®</button>
            </div>
        </div>
    </div>

    <!-- ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-modal-content">
            <div class="preview-image-container">
                <img class="preview-image" id="previewImage" src="" alt="È¢ÑËßà">
            </div>
            <div class="preview-info">
                <span class="preview-sender" id="previewSender"></span>
                <div class="preview-actions">
                    <button class="preview-close" id="previewCloseBtn">ÂÖ≥Èó≠</button>
                    <button class="preview-download" id="previewDownloadBtn">‰øùÂ≠òÂõæÁâá</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ---------- 20‰∏≠Â≠¶P2PËÅäÂ§©ÂÆ§ ¬∑ Êï¥ÂêàÂèØÈù†ÁöÑÊñá‰ª∂‰º†Ëæì ----------
        import Peer from 'https://esm.sh/peerjs@1.5.4?bundle-deps';
        import Cropper from 'https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/+esm';

        const PEER_OPTIONS = {
            config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] }
        };
        const FIXED_HUB_ID = '20zhongxue-p2p-hub-2026';

        let peer = null;
        let myId = null;
        let myName = 'ÂêåÂ≠¶' + Math.floor(Math.random() * 100);
        let isAnonymous = false;
        let myAvatarData = null;
        const connections = new Map();
        const mySentMessages = new Map();

        let pendingFiles = [];

        // Âú®Á∫øÁî®Êà∑ÁÆ°ÁêÜ
        const onlineUsers = new Map();            // key: userId, value: { name, anon, avatar, lastSeen, missedHeartbeats }
        const joinedNotified = new Set();         // ËÆ∞ÂΩïÂ∑≤ÁªèÊòæÁ§∫ËøáÂä†ÂÖ•Ê∂àÊÅØÁöÑÁî®Êà∑
        
        const messageHistory = new Set();         // Â≠òÂÇ®ÊúÄËøëÊî∂Âà∞ÁöÑÊ∂àÊÅØID
        const MAX_HISTORY_SIZE = 200;

        // ÂøÉË∑≥Ê£ÄÊµã
        let heartbeatInterval = null;
        const HEARTBEAT_INTERVAL = 8000;          // 8Áßí‰∏ÄÊ¨°ÂøÉË∑≥
        const MAX_MISSED_HEARTBEATS = 3;           // ÂÖÅËÆ∏ËøûÁª≠‰∏¢Â§±3Ê¨°ÂøÉË∑≥ÊâçÂà§ÂÆöÁ¶ªÁ∫ø

        // DOM ÂÖÉÁ¥†
        const messageContainer = document.getElementById('messageContainer');
        const peerCountDisplay = document.getElementById('peerCountDisplay');
        const nicknameInput = document.getElementById('nicknameInput');
        const renameButton = document.getElementById('renameButton');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const anonCheckbox = document.getElementById('anonCheckbox');
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarPreview = document.getElementById('avatarPreview');
        const fileInput = document.getElementById('fileInput');
        const selectedFilesPreview = document.getElementById('selectedFilesPreview');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const resetAvatarBtn = document.getElementById('resetAvatarBtn');

        const cropModal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');
        const cancelCrop = document.getElementById('cancelCrop');
        const applyCrop = document.getElementById('applyCrop');
        let cropper = null;

        // ÂõæÁâáÈ¢ÑËßàÁõ∏ÂÖ≥
        const previewModal = document.getElementById('previewModal');
        const previewImage = document.getElementById('previewImage');
        const previewSender = document.getElementById('previewSender');
        const previewCloseBtn = document.getElementById('previewCloseBtn');
        const previewDownloadBtn = document.getElementById('previewDownloadBtn');

        nicknameInput.value = myName;

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function generateMsgId() { return Date.now() + '-' + Math.random().toString(36).substring(2,10); }

        function escapeHTML(str) { return String(str).replace(/[&<>"]/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

        // ÂõæÁâáÈ¢ÑËßàÂáΩÊï∞
        function showImagePreview(imgSrc, senderName, isAnon) {
            previewImage.src = imgSrc;
            previewSender.textContent = `ÂèëÈÄÅËÄÖ: ${isAnon ? 'ÂåøÂêç' : senderName}`;
            previewModal.style.display = 'flex';
        }

        function closeImagePreview() {
            previewModal.style.display = 'none';
            previewImage.src = '';
        }

        function downloadImage() {
            const imgSrc = previewImage.src;
            if (!imgSrc) return;
            
            const timestamp = new Date().getTime();
            const filename = `image_${timestamp}.png`;
            
            const link = document.createElement('a');
            link.href = imgSrc;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        previewCloseBtn.addEventListener('click', closeImagePreview);
        previewDownloadBtn.addEventListener('click', downloadImage);
        
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) {
                closeImagePreview();
            }
        });

        // Êñá‰ª∂È¢ÑËßà
        function updateFilePreview() {
            if (!pendingFiles.length) { 
                selectedFilesPreview.innerHTML = ''; 
                return; 
            }
            let html = '';
            pendingFiles.forEach((file, index) => {
                const name = file.name.length > 20 ? file.name.slice(0,17)+'...' : file.name;
                html += `<div class="file-tag">üìé ${escapeHTML(name)} (${(file.size/1024).toFixed(1)}KB)
                    <button class="remove-file" data-index="${index}">‚úï</button>
                </div>`;
            });
            selectedFilesPreview.innerHTML = html;
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.index);
                    pendingFiles.splice(idx, 1);
                    updateFilePreview();
                });
            });
        }

        fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);
            pendingFiles = [...pendingFiles, ...newFiles];
            updateFilePreview();
            fileInput.value = '';
        });

        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

        // Â§¥ÂÉèË£ÅÂâ™
        avatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                cropImage.src = ev.target.result;
                cropModal.style.display = 'flex';
                if (cropper) cropper.destroy();
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    cropBoxResizable: true,
                    background: false,
                });
            };
            reader.readAsDataURL(file);
            avatarUpload.value = '';
        });

        cancelCrop.addEventListener('click', () => {
            cropModal.style.display = 'none';
            if (cropper) { cropper.destroy(); cropper = null; }
        });

        applyCrop.addEventListener('click', () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 200, height: 200 });
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    myAvatarData = e.target.result;
                    avatarPreview.style.backgroundImage = `url('${myAvatarData}')`;
                    avatarPreview.textContent = '';
                    cropModal.style.display = 'none';
                    if (cropper) { cropper.destroy(); cropper = null; }
                };
                reader.readAsDataURL(blob);
            }, 'image/png');
        });

        resetAvatarBtn.addEventListener('click', () => {
            myAvatarData = null;
            avatarPreview.style.backgroundImage = '';
            avatarPreview.textContent = 'üì∑';
        });

        // ÊîπÂêçÂäüËÉΩ
        renameButton.addEventListener('click', () => {
            const newName = nicknameInput.value.trim();
            if (newName && newName !== myName) {
                myName = newName;
                addSystemMessage(`‚ú® ÊòµÁß∞Â∑≤‰øÆÊîπ‰∏∫ "${myName}"`);
            } else {
                nicknameInput.value = myName;
            }
        });

        nicknameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                renameButton.click();
            }
        });

        anonCheckbox.addEventListener('change', (e) => { isAnonymous = e.target.checked; });

        // Êõ¥Êñ∞Âú®Á∫ø‰∫∫Êï∞ÊòæÁ§∫
        function updatePeerCount() {
            const count = onlineUsers.size;
            peerCountDisplay.innerHTML = `${count} ‰∫∫Âú®Á∫ø`;
        }

        // Ê∑ªÂä†Áî®Êà∑Âà∞Âú®Á∫øÈõÜÂêà
        function addOnlineUser(userId, userData) {
            if (!userId || userId === myId) return false;
            
            if (!onlineUsers.has(userId)) {
                onlineUsers.set(userId, {
                    name: userData.name || 'Êú™Áü•Áî®Êà∑',
                    anon: userData.anon || false,
                    avatar: userData.avatar || null,
                    lastSeen: Date.now(),
                    missedHeartbeats: 0
                });
                
                updatePeerCount();
                
                if (!joinedNotified.has(userId)) {
                    joinedNotified.add(userId);
                    const displayName = userData.anon ? 'ÂåøÂêçÁî®Êà∑' : (userData.name || '‰∏Ä‰Ωç‰ºô‰º¥');
                    addSystemMessage(`‚û§ ${displayName} Âä†ÂÖ•‰∫ÜËÅäÂ§©`);
                }
                
                return true;
            } else {
                const existing = onlineUsers.get(userId);
                existing.lastSeen = Date.now();
                existing.missedHeartbeats = 0;
                if (userData.name) existing.name = userData.name;
                if (userData.anon !== undefined) existing.anon = userData.anon;
                if (userData.avatar) existing.avatar = userData.avatar;
                
                return false;
            }
        }

        // ‰ªéÂú®Á∫øÈõÜÂêà‰∏≠ÁßªÈô§Áî®Êà∑
        function removeOnlineUser(userId, reason = 'Á¶ªÂºÄ') {
            if (!userId || userId === myId) return false;
            
            if (onlineUsers.has(userId)) {
                const userData = onlineUsers.get(userId);
                const displayName = userData.anon ? 'ÂåøÂêçÁî®Êà∑' : (userData.name || '‰∏Ä‰Ωç‰ºô‰º¥');
                
                onlineUsers.delete(userId);
                joinedNotified.delete(userId);
                
                updatePeerCount();
                addSystemMessage(`‚úó ${displayName} ${reason}`);
                
                return true;
            }
            return false;
        }

        // ÂπøÊí≠ÂøÉË∑≥
        function broadcastHeartbeat() {
            const heartbeatMsg = {
                type: 'heartbeat',
                userId: myId,
                name: myName,
                anon: isAnonymous,
                avatar: myAvatarData,
                time: Date.now()
            };
            
            for (let conn of connections.values()) {
                if (conn.open) {
                    try { conn.send(heartbeatMsg); } catch(e) {}
                }
            }
        }

        // ËØ∑Ê±ÇÂÖ®ÁΩëÁî®Êà∑ÂàóË°®
        function requestUserList() {
            const requestMsg = {
                type: 'requestUserList',
                userId: myId,
                time: Date.now()
            };
            
            for (let conn of connections.values()) {
                if (conn.open) {
                    try { conn.send(requestMsg); } catch(e) {}
                }
            }
        }

        // ÂèëÈÄÅÁî®Êà∑ÂàóË°®ÁªôÊåáÂÆöËøûÊé•
        function sendUserListTo(conn) {
            if (!conn || !conn.open) return;
            
            const userList = [];
            for (let [userId, userData] of onlineUsers.entries()) {
                if (userId !== myId) {
                    userList.push({
                        userId: userId,
                        name: userData.name,
                        anon: userData.anon,
                        avatar: userData.avatar
                    });
                }
            }
            
            const listMsg = {
                type: 'userList',
                users: userList,
                fromId: myId,
                time: Date.now()
            };
            
            try { conn.send(listMsg); } catch(e) {}
        }

        // ÂøÉË∑≥Ê£ÄÊµã
        function checkUserTimeouts() {
            const now = Date.now();
            const timeoutUsers = [];
            
            for (let [userId, userData] of onlineUsers.entries()) {
                if (userId === myId) continue;
                
                const timeSinceLastSeen = now - userData.lastSeen;
                
                if (timeSinceLastSeen > HEARTBEAT_INTERVAL) {
                    userData.missedHeartbeats = (userData.missedHeartbeats || 0) + 1;
                    
                    if (userData.missedHeartbeats > MAX_MISSED_HEARTBEATS) {
                        timeoutUsers.push(userId);
                    }
                } else {
                    userData.missedHeartbeats = 0;
                }
            }
            
            timeoutUsers.forEach(userId => {
                removeOnlineUser(userId, 'Ë∂ÖÊó∂Á¶ªÂºÄ');
            });
        }

        // ÂêØÂä®ÂøÉË∑≥Ê£ÄÊµã
        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            
            heartbeatInterval = setInterval(() => {
                broadcastHeartbeat();
                checkUserTimeouts();
                
                for (let [peerId, conn] of connections.entries()) {
                    if (!conn.open) {
                        connections.delete(peerId);
                        removeOnlineUser(peerId, 'ËøûÊé•Â§±Êïà');
                    }
                }
            }, HEARTBEAT_INTERVAL);
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞UI
        function addMessageToUI(msgData, isSelf = false) {
            const { msgId, text, sender, time, files, recalled, senderAvatar, senderAnon } = msgData;
            if (recalled) return;

            const wrapper = document.createElement('div');
            wrapper.classList.add('message');
            if (msgId) wrapper.setAttribute('data-msgid', msgId);
            if (isSelf) wrapper.classList.add('message-self');
            else wrapper.classList.add('message-other');

            const headerDiv = document.createElement('div');
            headerDiv.classList.add('message-header');

            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('msg-avatar');

            let displayName = sender;
            if (senderAnon === true) {
                displayName = 'ÂåøÂêç';
                avatarDiv.style.backgroundImage = '';
                avatarDiv.textContent = '?';
            } else {
                if (senderAvatar) {
                    avatarDiv.style.backgroundImage = `url('${senderAvatar}')`;
                    avatarDiv.textContent = '';
                } else {
                    avatarDiv.textContent = displayName.charAt(0).toUpperCase();
                }
            }

            const nameSpan = document.createElement('span');
            nameSpan.classList.add('sender-name');
            nameSpan.textContent = displayName;

            const timeSpan = document.createElement('span');
            timeSpan.classList.add('timestamp');
            timeSpan.textContent = time ? new Date(time).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : '';

            headerDiv.appendChild(avatarDiv);
            headerDiv.appendChild(nameSpan);
            headerDiv.appendChild(timeSpan);

            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('message-bubble');

            const bodyDiv = document.createElement('div');
            bodyDiv.classList.add('message-body');
            bodyDiv.textContent = text || '';

            bubbleDiv.appendChild(bodyDiv);

            if (files && files.length > 0) {
                const attachDiv = document.createElement('div');
                attachDiv.classList.add('file-attachment');
                files.forEach(f => {
                    if (f.type.startsWith('image/')) {
                        const imgWrap = document.createElement('a');
                        imgWrap.href = f.data;
                        imgWrap.target = '_blank';
                        imgWrap.classList.add('image-preview');
                        
                        const img = document.createElement('img');
                        img.src = f.data;
                        img.alt = f.name;
                        
                        // Ê∑ªÂä†ÁÇπÂáªÈ¢ÑËßà‰∫ã‰ª∂
                        img.addEventListener('click', (e) => {
                            e.preventDefault();
                            showImagePreview(f.data, sender, senderAnon);
                        });
                        
                        imgWrap.appendChild(img);
                        attachDiv.appendChild(imgWrap);
                    } else {
                        const link = document.createElement('a');
                        link.href = f.data;
                        link.download = f.name;
                        link.classList.add('file-link');
                        link.textContent = `üìé ${f.name}`;
                        attachDiv.appendChild(link);
                    }
                });
                bubbleDiv.appendChild(attachDiv);
            }

            if (isSelf && msgId) {
                const recallBtn = document.createElement('button');
                recallBtn.classList.add('recall-btn');
                recallBtn.textContent = 'Êí§Âõû';
                recallBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    recallMessage(msgId);
                });
                bubbleDiv.appendChild(recallBtn);
            }

            wrapper.appendChild(headerDiv);
            wrapper.appendChild(bubbleDiv);
            messageContainer.appendChild(wrapper);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function addSystemMessage(text) {
            const sysDiv = document.createElement('div');
            sysDiv.classList.add('system-message');
            sysDiv.textContent = text;
            messageContainer.appendChild(sysDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function recallMessage(msgId) {
            if (!msgId || !mySentMessages.has(msgId)) return;
            document.querySelectorAll(`[data-msgid="${msgId}"]`).forEach(el => el.remove());
            mySentMessages.delete(msgId);
            const recallPayload = { type: 'recall', msgId, originId: myId };
            for (let conn of connections.values()) if (conn.open) conn.send(recallPayload);
        }

        // ---------- ‰ªéËøôÈáåÂºÄÂßãÊòØÊï¥ÂêàÁöÑÂèØÈù†Êñá‰ª∂‰º†ËæìÈÉ®ÂàÜ ----------
        async function broadcastMessage(text) {
            const msgId = generateMsgId();
            let fileArray = null;
            
            // Â§ÑÁêÜÊñá‰ª∂ - ‰ΩøÁî®ÂèØÈù†ÁöÑÊñá‰ª∂ËØªÂèñÊñπÂºè
            if (pendingFiles.length > 0) {
                fileArray = await Promise.all(pendingFiles.map(async (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            resolve({ 
                                name: file.name, 
                                type: file.type, 
                                data: e.target.result 
                            });
                        };
                        reader.onerror = (e) => {
                            console.error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•', e);
                            reject(e);
                        };
                        reader.readAsDataURL(file);
                    });
                }));
            }

            // ÊûÑÂª∫Ê∂àÊÅØË¥üËΩΩ
            const messagePayload = {
                type: 'chat', 
                msgId, 
                text: text || '',
                sender: isAnonymous ? 'ÂåøÂêç' : myName,
                time: Date.now(), 
                originId: myId,
                files: fileArray,
                senderAvatar: isAnonymous ? null : (myAvatarData || null),
                senderAnon: isAnonymous
            };

            // ‰øùÂ≠òÂà∞Â∑≤ÂèëÈÄÅÊ∂àÊÅØ
            mySentMessages.set(msgId, messagePayload);
            
            // Êú¨Âú∞ÊòæÁ§∫
            addMessageToUI(messagePayload, true);

            // Ê∑ªÂä†Âà∞Ê∂àÊÅØÂéÜÂè≤
            messageHistory.add(msgId);
            if (messageHistory.size > MAX_HISTORY_SIZE) {
                const first = messageHistory.values().next().value;
                messageHistory.delete(first);
            }

            // ÂèëÈÄÅÁªôÊâÄÊúâËøûÊé•ÁöÑ peer
            for (let conn of connections.values()) {
                if (conn.open) {
                    try { 
                        conn.send(messagePayload); 
                    } catch(e) {
                        console.warn('ÂèëÈÄÅÂ§±Ë¥•', e);
                    }
                }
            }

            // Ê∏ÖÁ©∫ÂæÖÂèëÈÄÅÊñá‰ª∂
            pendingFiles = [];
            updateFilePreview();
        }

        // Â§ÑÁêÜÊé•Êî∂Âà∞ÁöÑÊï∞ÊçÆ
        function handleData(conn, data) {
            // Èò≤Ê≠¢Â§ÑÁêÜËá™Â∑±ÁöÑÊ∂àÊÅØ
            if (data.originId === myId) return;
            
            // Ê£ÄÊü•Ê∂àÊÅØÂéÜÂè≤
            if (data.msgId && messageHistory.has(data.msgId)) {
                return;
            }
            
            if (data.msgId) {
                messageHistory.add(data.msgId);
                if (messageHistory.size > MAX_HISTORY_SIZE) {
                    const first = messageHistory.values().next().value;
                    messageHistory.delete(first);
                }
            }

            // Â§ÑÁêÜÂøÉË∑≥
            if (data.type === 'heartbeat') {
                if (data.userId && data.userId !== myId) {
                    addOnlineUser(data.userId, {
                        name: data.name,
                        anon: data.anon,
                        avatar: data.avatar
                    });
                }
                return;
            }

            // Â§ÑÁêÜËÅäÂ§©Ê∂àÊÅØ
            if (data.type === 'chat') {
                if (data.recalled) return;
                
                // Êî∂Âà∞Ê∂àÊÅØÔºåÁõ¥Êé•ÊòæÁ§∫
                addMessageToUI(data, false);
                
                // Ê∂àÊÅØ‰∏≠Áªß - ËΩ¨ÂèëÁªôÂÖ∂‰ªñËøûÊé•
                for (let [peerId, otherConn] of connections.entries()) {
                    if (peerId !== conn.peer && otherConn.open) {
                        try { 
                            otherConn.send(data); 
                        } catch(e) {}
                    }
                }
            } 
            // Â§ÑÁêÜÊí§ÂõûÊ∂àÊÅØ
            else if (data.type === 'recall') {
                if (data.msgId) {
                    document.querySelectorAll(`[data-msgid="${data.msgId}"]`).forEach(el => el.remove());
                }
                for (let [peerId, otherConn] of connections.entries()) {
                    if (peerId !== conn.peer && otherConn.open) {
                        try { otherConn.send(data); } catch(e) {}
                    }
                }
            }
            // Â§ÑÁêÜÊè°Êâã
            else if (data.type === 'handshake') {
                conn.metadata = conn.metadata || {};
                conn.metadata.remoteName = data.name;
                conn.metadata.remoteAvatar = data.avatar;
                conn.metadata.remoteAnon = data.anon || false;
                
                // Âä†ÂÖ•Âú®Á∫øÁî®Êà∑
                addOnlineUser(data.originId, {
                    name: data.name,
                    anon: data.anon,
                    avatar: data.avatar
                });
                
                // ÂõûÂ§çËá™Â∑±ÁöÑ‰ø°ÊÅØ
                if (conn.open) {
                    conn.send({ 
                        type: 'peerInfo', 
                        name: myName, 
                        avatar: myAvatarData, 
                        anon: isAnonymous, 
                        originId: myId 
                    });
                }
            } 
            // Â§ÑÁêÜÁî®Êà∑‰ø°ÊÅØ
            else if (data.type === 'peerInfo') {
                conn.metadata = conn.metadata || {};
                conn.metadata.remoteName = data.name;
                conn.metadata.remoteAvatar = data.avatar;
                conn.metadata.remoteAnon = data.anon;
                
                addOnlineUser(data.originId, {
                    name: data.name,
                    anon: data.anon,
                    avatar: data.avatar
                });
            }
            // Â§ÑÁêÜÁî®Êà∑ÂàóË°®ËØ∑Ê±Ç
            else if (data.type === 'requestUserList') {
                sendUserListTo(conn);
            }
            // Êé•Êî∂Áî®Êà∑ÂàóË°®
            else if (data.type === 'userList') {
                if (data.users && Array.isArray(data.users)) {
                    data.users.forEach(user => {
                        if (user.userId && user.userId !== myId) {
                            addOnlineUser(user.userId, {
                                name: user.name,
                                anon: user.anon,
                                avatar: user.avatar
                            });
                        }
                    });
                }
            }
        }

        // Âª∫Á´ãÊñ∞ËøûÊé•
        function setupConnection(conn) {
            const remoteId = conn.peer;
            
            if (connections.has(remoteId)) {
                try { connections.get(remoteId).close(); } catch(e) {}
            }
            
            connections.set(remoteId, conn);

            conn.on('data', (data) => handleData(conn, data));
            
            conn.on('close', () => {
                connections.delete(remoteId);
                removeOnlineUser(remoteId, 'Êñ≠ÂºÄËøûÊé•');
            });
            
            conn.on('error', (err) => {
                console.warn('ËøûÊé•ÈîôËØØ', remoteId, err);
            });

            // ËøûÊé•Âª∫Á´ãÂêéÂèëÈÄÅÊè°Êâã
            setTimeout(() => {
                if (conn.open) {
                    conn.send({ 
                        type: 'handshake', 
                        name: myName, 
                        avatar: myAvatarData, 
                        anon: isAnonymous, 
                        originId: myId 
                    });
                    
                    // ËØ∑Ê±ÇÁî®Êà∑ÂàóË°®
                    conn.send({
                        type: 'requestUserList',
                        userId: myId,
                        time: Date.now()
                    });
                }
            }, 500);
        }

        // ‰∏ªÂä®ËøûÊé•
        function connectToPeer(remoteId) {
            if (!peer || remoteId === myId || connections.has(remoteId)) return;
            
            const conn = peer.connect(remoteId, { reliable: true });
            
            conn.on('open', () => {
                setupConnection(conn);
            });
            
            conn.on('error', (e) => {
                console.warn('ËøûÊé•Â§±Ë¥•', remoteId, e);
            });
        }

        // ÂàùÂßãÂåñPeer
        function initPeer() {
            if (peer) {
                peer.destroy();
                connections.clear();
                onlineUsers.clear();
                joinedNotified.clear();
                messageHistory.clear();
            }

            // ÂÖàÊ∑ªÂä†Ëá™Â∑±Âà∞Âú®Á∫øÈõÜÂêà
            onlineUsers.set('temp', { name: myName, anon: isAnonymous, avatar: myAvatarData, lastSeen: Date.now() });

            peer = new Peer(FIXED_HUB_ID, PEER_OPTIONS);

            peer.on('open', (id) => {
                myId = id;
                
                onlineUsers.delete('temp');
                onlineUsers.set(id, { 
                    name: myName, 
                    anon: isAnonymous, 
                    avatar: myAvatarData,
                    lastSeen: Date.now(),
                    missedHeartbeats: 0
                });
                updatePeerCount();
                
                if (id === FIXED_HUB_ID) {
                    addSystemMessage('‚úÖ ‰Ω†ÊòØ‰∏ªÊåÅ‰∫∫ÔºåÂ∏ÆÂä©Êñ∞Áî®Êà∑‰∫íÁõ∏ÂèëÁé∞');
                } else {
                    addSystemMessage(`üîÑ Â∑≤ËøûÊé•ÔºåID: ${id}`);
                    setTimeout(() => {
                        connectToPeer(FIXED_HUB_ID);
                    }, 500);
                }
                
                startHeartbeat();
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id' || (err.message && err.message.includes('ID'))) {
                    peer.destroy();
                    peer = new Peer(PEER_OPTIONS);
                    
                    peer.on('open', (randomId) => {
                        myId = randomId;
                        
                        onlineUsers.set(randomId, { 
                            name: myName, 
                            anon: isAnonymous, 
                            avatar: myAvatarData,
                            lastSeen: Date.now(),
                            missedHeartbeats: 0
                        });
                        updatePeerCount();
                        
                        addSystemMessage(`üîÑ Â∑≤Âä†ÂÖ•ËÅäÂ§©ÂÆ§ÔºåID: ${randomId}`);
                        
                        setTimeout(() => {
                            connectToPeer(FIXED_HUB_ID);
                        }, 500);
                        
                        startHeartbeat();
                    });
                } else {
                    console.warn('PeerÈîôËØØ:', err);
                }
            });

            peer.on('connection', (conn) => {
                setupConnection(conn);
            });

            peer.on('disconnected', () => {
                addSystemMessage('‚ö†Ô∏è ËøûÊé•Êñ≠ÂºÄÔºåÂ∞ùËØïÈáçËøû...');
                setTimeout(() => {
                    peer.reconnect();
                }, 2000);
            });
        }

        // ÂêØÂä®
        initPeer();
        
        setInterval(() => {
            updatePeerCount();
        }, 2000);

        // ÂèëÈÄÅÊ∂àÊÅØ
        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text && pendingFiles.length === 0) return;
            await broadcastMessage(text);
            messageInput.value = '';
        });
        
        messageInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') sendButton.click(); 
        });

        // Ë∞ÉËØï
        window.__debug = { 
            connections: connections, 
            myId: myId,
            onlineUsers: onlineUsers
        };
    </script>
</body>
</html>
